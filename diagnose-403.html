<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>nginx 403é”™è¯¯è¯Šæ–­å·¥å…·</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .test-section h3 {
            color: #dc2626;
            margin-top: 0;
        }
        .button {
            background: #dc2626;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #b91c1c;
        }
        .button.success {
            background: #059669;
        }
        .button.info {
            background: #2563eb;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .result.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .result.info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-success { background: #10b981; }
        .status-error { background: #ef4444; }
        .status-warning { background: #f59e0b; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš¨ nginx 403é”™è¯¯è¯Šæ–­å·¥å…·</h1>
            <p>ä¸“é—¨è¯Šæ–­å’Œè§£å†³APIå¯¼å…¥åŠŸèƒ½çš„nginx 403 Forbiddené”™è¯¯</p>
        </div>

        <!-- 1. APIç«¯ç‚¹å¯è¾¾æ€§æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ” APIç«¯ç‚¹å¯è¾¾æ€§æµ‹è¯•</h3>
            <p>æµ‹è¯•å„ä¸ªAPIç«¯ç‚¹æ˜¯å¦å¯ä»¥æ­£å¸¸è®¿é—®</p>
            <button class="button info" onclick="testAPIEndpoints()">æµ‹è¯•APIç«¯ç‚¹</button>
            <button class="button info" onclick="testDirectPHP()">æµ‹è¯•ç›´æ¥PHPè®¿é—®</button>
            <div id="endpoint-result" class="result" style="display: none;"></div>
        </div>

        <!-- 2. æƒé™å’Œè·¯ç”±è¯Šæ–­ -->
        <div class="test-section">
            <h3>ğŸ” æƒé™å’Œè·¯ç”±è¯Šæ–­</h3>
            <p>æ£€æŸ¥æ–‡ä»¶æƒé™ã€è·¯ç”±é…ç½®å’ŒæœåŠ¡å™¨å“åº”</p>
            <button class="button" onclick="diagnosePermissions()">è¯Šæ–­æƒé™é—®é¢˜</button>
            <button class="button" onclick="testRouting()">æµ‹è¯•è·¯ç”±é…ç½®</button>
            <div id="permission-result" class="result" style="display: none;"></div>
        </div>

        <!-- 3. å¯¼å…¥åŠŸèƒ½ä¸“é¡¹æµ‹è¯• -->
        <div class="test-section">
            <h3>ğŸ“¤ å¯¼å…¥åŠŸèƒ½ä¸“é¡¹æµ‹è¯•</h3>
            <p>ä¸“é—¨æµ‹è¯•é…ç½®å¯¼å…¥åŠŸèƒ½çš„å„ç§è®¿é—®æ–¹å¼</p>
            <button class="button" onclick="testImportEndpoint()">æµ‹è¯•å¯¼å…¥ç«¯ç‚¹</button>
            <button class="button" onclick="testDifferentMethods()">æµ‹è¯•ä¸åŒHTTPæ–¹æ³•</button>
            <div id="import-result" class="result" style="display: none;"></div>
        </div>

        <!-- 4. æœåŠ¡å™¨ä¿¡æ¯æ”¶é›† -->
        <div class="test-section">
            <h3>ğŸ–¥ï¸ æœåŠ¡å™¨ä¿¡æ¯æ”¶é›†</h3>
            <p>æ”¶é›†æœåŠ¡å™¨é…ç½®å’Œç¯å¢ƒä¿¡æ¯</p>
            <button class="button info" onclick="collectServerInfo()">æ”¶é›†æœåŠ¡å™¨ä¿¡æ¯</button>
            <button class="button info" onclick="testCORS()">æµ‹è¯•CORSé…ç½®</button>
            <div id="server-result" class="result" style="display: none;"></div>
        </div>

        <!-- 5. ç»¼åˆè¯Šæ–­æŠ¥å‘Š -->
        <div class="test-section">
            <h3>ğŸ“Š ç»¼åˆè¯Šæ–­æŠ¥å‘Š</h3>
            <p>è¿è¡Œå®Œæ•´çš„403é”™è¯¯è¯Šæ–­å¹¶ç”Ÿæˆè§£å†³æ–¹æ¡ˆ</p>
            <button class="button success" onclick="runFullDiagnosis()">è¿è¡Œå®Œæ•´è¯Šæ–­</button>
            <div id="full-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
        }

        // 1. æµ‹è¯•APIç«¯ç‚¹
        async function testAPIEndpoints() {
            showResult('endpoint-result', 'æ­£åœ¨æµ‹è¯•APIç«¯ç‚¹å¯è¾¾æ€§...', 'info');
            
            const endpoints = [
                '/api/health',
                '/api/import',
                '/api/environments',
                '/api/test.php',
                '/api/index.php'
            ];
            
            let report = 'APIç«¯ç‚¹å¯è¾¾æ€§æµ‹è¯•æŠ¥å‘Š:\n\n';
            
            for (const endpoint of endpoints) {
                try {
                    const response = await fetch(endpoint, {
                        method: 'GET',
                        cache: 'no-cache'
                    });
                    
                    const status = response.status;
                    const statusText = response.statusText;
                    
                    if (status === 200) {
                        report += `âœ… ${endpoint}: ${status} ${statusText}\n`;
                    } else if (status === 403) {
                        report += `âŒ ${endpoint}: ${status} ${statusText} (403 FORBIDDEN)\n`;
                    } else {
                        report += `âš ï¸ ${endpoint}: ${status} ${statusText}\n`;
                    }
                } catch (error) {
                    report += `âŒ ${endpoint}: è¿æ¥é”™è¯¯ - ${error.message}\n`;
                }
            }
            
            showResult('endpoint-result', report, 'info');
        }

        async function testDirectPHP() {
            showResult('endpoint-result', 'æ­£åœ¨æµ‹è¯•ç›´æ¥PHPæ–‡ä»¶è®¿é—®...', 'info');
            
            try {
                const response = await fetch('/api/test.php');
                const data = await response.text();
                
                if (response.ok) {
                    showResult('endpoint-result', `âœ… ç›´æ¥PHPè®¿é—®æˆåŠŸ:\n${data}`, 'success');
                } else {
                    showResult('endpoint-result', `âŒ ç›´æ¥PHPè®¿é—®å¤±è´¥ (${response.status}):\n${data}`, 'error');
                }
            } catch (error) {
                showResult('endpoint-result', `âŒ ç›´æ¥PHPè®¿é—®é”™è¯¯: ${error.message}`, 'error');
            }
        }

        // 2. è¯Šæ–­æƒé™é—®é¢˜
        async function diagnosePermissions() {
            showResult('permission-result', 'æ­£åœ¨è¯Šæ–­æƒé™å’Œé…ç½®é—®é¢˜...', 'info');
            
            let report = 'æƒé™å’Œé…ç½®è¯Šæ–­æŠ¥å‘Š:\n\n';
            
            // æµ‹è¯•ä¸åŒçš„è¯·æ±‚æ–¹å¼
            const tests = [
                { method: 'GET', url: '/api/import' },
                { method: 'POST', url: '/api/import' },
                { method: 'OPTIONS', url: '/api/import' },
                { method: 'GET', url: '/api/' },
                { method: 'GET', url: '/api/index.php' }
            ];
            
            for (const test of tests) {
                try {
                    const response = await fetch(test.url, {
                        method: test.method,
                        headers: test.method === 'POST' ? { 'Content-Type': 'application/json' } : {}
                    });
                    
                    report += `${test.method} ${test.url}: ${response.status} ${response.statusText}\n`;
                    
                    if (response.status === 403) {
                        const errorBody = await response.text();
                        if (errorBody.includes('nginx')) {
                            report += `  âš ï¸ nginxçº§åˆ«çš„403é”™è¯¯\n`;
                        }
                    }
                } catch (error) {
                    report += `${test.method} ${test.url}: é”™è¯¯ - ${error.message}\n`;
                }
            }
            
            showResult('permission-result', report, 'info');
        }

        async function testRouting() {
            showResult('permission-result', 'æ­£åœ¨æµ‹è¯•è·¯ç”±é…ç½®...', 'info');
            
            // æµ‹è¯•è·¯ç”±é‡å†™æ˜¯å¦æ­£å¸¸å·¥ä½œ
            const routeTests = [
                '/api/test',
                '/api/import',
                '/api/nonexistent',
                '/api/health'
            ];
            
            let report = 'è·¯ç”±é…ç½®æµ‹è¯•:\n\n';
            
            for (const route of routeTests) {
                try {
                    const response = await fetch(route);
                    const isNginx403 = response.status === 403 && (await response.text()).includes('nginx');
                    
                    report += `${route}: ${response.status}`;
                    if (isNginx403) {
                        report += ` (nginx 403 - è·¯ç”±é—®é¢˜)`;
                    }
                    report += '\n';
                } catch (error) {
                    report += `${route}: é”™è¯¯ - ${error.message}\n`;
                }
            }
            
            showResult('permission-result', report, 'info');
        }

        // 3. æµ‹è¯•å¯¼å…¥ç«¯ç‚¹
        async function testImportEndpoint() {
            showResult('import-result', 'æ­£åœ¨ä¸“é¡¹æµ‹è¯•å¯¼å…¥ç«¯ç‚¹...', 'info');
            
            const testData = {
                environments: [{
                    name: '403è¯Šæ–­æµ‹è¯•',
                    url: 'https://httpbin.org/status/200',
                    description: 'ç”¨äºè¯Šæ–­403é”™è¯¯çš„æµ‹è¯•ç¯å¢ƒ'
                }]
            };
            
            let report = 'å¯¼å…¥ç«¯ç‚¹ä¸“é¡¹æµ‹è¯•:\n\n';
            
            try {
                // æµ‹è¯•1: æ ‡å‡†POSTè¯·æ±‚
                report += '1. æ ‡å‡†POSTè¯·æ±‚æµ‹è¯•:\n';
                const response1 = await fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                report += `   çŠ¶æ€: ${response1.status} ${response1.statusText}\n`;
                const body1 = await response1.text();
                
                if (response1.status === 403 && body1.includes('nginx')) {
                    report += '   âŒ nginxçº§åˆ«çš„403é”™è¯¯ - è¿™æ˜¯é—®é¢˜æ‰€åœ¨!\n';
                    report += '   åŸå› : è¯·æ±‚è¢«nginxé˜»æ­¢ï¼Œæœªåˆ°è¾¾PHPåº”ç”¨\n';
                } else if (response1.ok) {
                    report += '   âœ… è¯·æ±‚æˆåŠŸ\n';
                } else {
                    report += `   âš ï¸ å…¶ä»–é”™è¯¯: ${body1}\n`;
                }
                
                // æµ‹è¯•2: ç›´æ¥è®¿é—®index.php
                report += '\n2. ç›´æ¥è®¿é—®index.phpæµ‹è¯•:\n';
                const response2 = await fetch('/api/index.php', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                report += `   çŠ¶æ€: ${response2.status} ${response2.statusText}\n`;
                
            } catch (error) {
                report += `æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}\n`;
            }
            
            showResult('import-result', report, 'info');
        }

        async function testDifferentMethods() {
            showResult('import-result', 'æ­£åœ¨æµ‹è¯•ä¸åŒHTTPæ–¹æ³•...', 'info');
            
            const methods = ['GET', 'POST', 'PUT', 'DELETE', 'OPTIONS'];
            let report = 'ä¸åŒHTTPæ–¹æ³•æµ‹è¯•:\n\n';
            
            for (const method of methods) {
                try {
                    const response = await fetch('/api/import', {
                        method: method,
                        headers: method === 'POST' ? { 'Content-Type': 'application/json' } : {}
                    });
                    
                    report += `${method}: ${response.status} ${response.statusText}`;
                    
                    if (response.status === 403) {
                        const body = await response.text();
                        if (body.includes('nginx')) {
                            report += ' (nginx 403)';
                        }
                    }
                    report += '\n';
                } catch (error) {
                    report += `${method}: é”™è¯¯ - ${error.message}\n`;
                }
            }
            
            showResult('import-result', report, 'info');
        }

        // 4. æ”¶é›†æœåŠ¡å™¨ä¿¡æ¯
        async function collectServerInfo() {
            showResult('server-result', 'æ­£åœ¨æ”¶é›†æœåŠ¡å™¨ä¿¡æ¯...', 'info');
            
            try {
                const response = await fetch('/api/test.php');
                if (response.ok) {
                    const data = await response.json();
                    showResult('server-result', `æœåŠ¡å™¨ä¿¡æ¯:\n${JSON.stringify(data, null, 2)}`, 'success');
                } else {
                    showResult('server-result', `æ— æ³•è·å–æœåŠ¡å™¨ä¿¡æ¯: ${response.status}`, 'error');
                }
            } catch (error) {
                showResult('server-result', `æ”¶é›†æœåŠ¡å™¨ä¿¡æ¯å¤±è´¥: ${error.message}`, 'error');
            }
        }

        async function testCORS() {
            showResult('server-result', 'æ­£åœ¨æµ‹è¯•CORSé…ç½®...', 'info');
            
            try {
                const response = await fetch('/api/import', {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type'
                    }
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers')
                };
                
                showResult('server-result', `CORSé…ç½®:\n${JSON.stringify(corsHeaders, null, 2)}`, 'info');
            } catch (error) {
                showResult('server-result', `CORSæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // 5. å®Œæ•´è¯Šæ–­
        async function runFullDiagnosis() {
            showResult('full-result', 'æ­£åœ¨è¿è¡Œå®Œæ•´çš„403é”™è¯¯è¯Šæ–­...', 'info');
            
            let report = 'ğŸš¨ nginx 403é”™è¯¯å®Œæ•´è¯Šæ–­æŠ¥å‘Š\n';
            report += '=' .repeat(60) + '\n\n';
            
            // é—®é¢˜ç¡®è®¤
            report += '1ï¸âƒ£ é—®é¢˜ç¡®è®¤:\n';
            try {
                const response = await fetch('/api/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ test: true })
                });
                
                if (response.status === 403) {
                    const body = await response.text();
                    if (body.includes('nginx')) {
                        report += '   âŒ ç¡®è®¤å­˜åœ¨nginxçº§åˆ«çš„403é”™è¯¯\n';
                        report += '   ğŸ“ é—®é¢˜ä½ç½®: nginxæœåŠ¡å™¨é…ç½®\n';
                        report += '   ğŸ” æ ¹æœ¬åŸå› : è¯·æ±‚è¢«nginxé˜»æ­¢ï¼Œæœªåˆ°è¾¾PHPåº”ç”¨\n\n';
                    }
                } else {
                    report += '   âœ… 403é”™è¯¯å·²è§£å†³æˆ–ä¸å­˜åœ¨\n\n';
                }
            } catch (error) {
                report += `   âŒ æµ‹è¯•è¿‡ç¨‹å‡ºé”™: ${error.message}\n\n`;
            }
            
            // è§£å†³æ–¹æ¡ˆ
            report += '2ï¸âƒ£ è§£å†³æ–¹æ¡ˆ:\n';
            report += '   A. æ£€æŸ¥.htaccessæ–‡ä»¶é…ç½®\n';
            report += '   B. éªŒè¯APIç›®å½•æƒé™è®¾ç½®\n';
            report += '   C. ç¡®è®¤nginxè·¯ç”±è§„åˆ™\n';
            report += '   D. æµ‹è¯•ç›´æ¥PHPæ–‡ä»¶è®¿é—®\n\n';
            
            // ç«‹å³ä¿®å¤æ­¥éª¤
            report += '3ï¸âƒ£ ç«‹å³ä¿®å¤æ­¥éª¤:\n';
            report += '   1. è®¿é—® /api/test.php ç¡®è®¤PHPå¯æ‰§è¡Œ\n';
            report += '   2. æ£€æŸ¥ .htaccess æ–‡ä»¶æ˜¯å¦æ­£ç¡®é…ç½®\n';
            report += '   3. éªŒè¯ api/ ç›®å½•æƒé™\n';
            report += '   4. æµ‹è¯•ä¸åŒçš„APIè®¿é—®è·¯å¾„\n\n';
            
            // æµ‹è¯•å»ºè®®
            report += '4ï¸âƒ£ æµ‹è¯•å»ºè®®:\n';
            report += '   â€¢ ä½¿ç”¨æœ¬é¡µé¢çš„å„é¡¹æµ‹è¯•åŠŸèƒ½\n';
            report += '   â€¢ æ£€æŸ¥æœåŠ¡å™¨é”™è¯¯æ—¥å¿—\n';
            report += '   â€¢ è”ç³»Serv00æŠ€æœ¯æ”¯æŒ\n';
            
            report += `\nğŸ“… è¯Šæ–­æ—¶é—´: ${new Date().toLocaleString()}`;
            
            showResult('full-result', report, 'error');
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš¨ nginx 403é”™è¯¯è¯Šæ–­å·¥å…·å·²åŠ è½½');
            
            // è‡ªåŠ¨æ£€æŸ¥APIå¯è¾¾æ€§
            setTimeout(() => {
                testAPIEndpoints();
            }, 1000);
        });
    </script>
</body>
</html>
