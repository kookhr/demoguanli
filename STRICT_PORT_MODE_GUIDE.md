# 🔒 Serv00 环境管理系统 - 严格端口模式指南

## 📋 概述

本指南介绍了 Serv00 环境管理系统的严格端口模式。在此模式下，系统将严格使用用户指定的端口，不会自动切换到其他端口，确保配置的一致性和可预测性。

---

## 🔄 变更说明

### 移除的功能

- ❌ **智能端口建议**: 不再自动建议可用端口
- ❌ **自动端口切换**: 不会自动切换到其他可用端口
- ❌ **端口搜索功能**: 移除了端口范围搜索逻辑

### 保留的功能

- ✅ **端口验证**: 继续验证端口范围（1024-65535）
- ✅ **端口占用检查**: 继续检查端口是否被占用
- ✅ **详细错误提示**: 提供清晰的错误信息和解决方案

---

## 🚀 新的端口处理逻辑

### 1. 部署时端口配置

当在部署过程中配置端口时：

```bash
请输入服务端口 (1024-65535) [默认: 3000]: 8080

# 如果端口被占用
⚠️  端口 8080 已被占用
ℹ️  可能的解决方案：
  1. 停止占用端口的服务
  2. 修改配置文件中的端口设置
  3. 强制使用被占用的端口（可能导致冲突）

端口占用详情：
tcp4  0  0  *.8080  *.*  LISTEN

请选择操作:
  1. 修改端口配置
  2. 强制使用此端口
  3. 取消安装

请选择 [1-3]:
```

### 2. 服务启动时端口检查

#### 前台模式

```bash
./start-server.sh

# 如果端口被占用
⚠️  配置端口 8080 已被占用
ℹ️  可能的解决方案：
  1. 停止占用端口的服务
  2. 修改配置文件中的端口设置
  3. 强制使用被占用的端口（可能导致冲突）

是否强制使用被占用的端口 8080? [y/N]:
```

#### 后台模式

```bash
./start-server.sh -d

# 如果端口被占用
⚠️  配置端口 8080 已被占用
❌ 后台模式下无法交互选择，请修改配置文件中的端口或停止占用进程
```

---

## 🔧 端口冲突解决方案

### 方案 1: 停止占用端口的服务

```bash
# 查找占用端口的进程
netstat -tuln | grep :8080
sockstat -l | grep :8080  # FreeBSD

# 查找进程 PID
lsof -i :8080  # 如果可用
ps aux | grep 8080

# 停止进程
kill <PID>
```

### 方案 2: 修改端口配置

```bash
# 编辑配置文件
vim demo-config.json

# 修改端口字段
{
  "deployment": {
    "port": 9000  # 修改为可用端口
  }
}
```

### 方案 3: 使用端口配置更新工具

```bash
# 使用端口配置更新脚本
./update-port-config.sh /path/to/install/dir 9000
```

---

## 📋 故障排除

### 常见错误和解决方案

#### 1. 端口被占用错误

**错误信息**:
```
⚠️  配置端口 8080 已被占用
❌ 后台模式下无法交互选择，请修改配置文件中的端口或停止占用进程
```

**解决方案**:
1. 检查端口占用：`netstat -tuln | grep :8080`
2. 停止占用进程或修改配置端口
3. 重新启动服务

#### 2. 端口范围无效

**错误信息**:
```
❌ 端口无效！请输入 1024-65535 范围内的数字
```

**解决方案**:
1. 使用 1024-65535 范围内的端口
2. 避免使用系统保留端口（1-1023）

#### 3. 配置文件端口格式错误

**错误信息**:
```
❌ 配置文件中的端口无效，使用默认端口 3000
```

**解决方案**:
1. 检查 `demo-config.json` 文件格式
2. 确保端口字段为数字类型
3. 重新生成配置文件

### 调试命令

```bash
# 检查当前配置
cat demo-config.json | grep port

# 检查端口占用
netstat -tuln | grep :PORT
sockstat -l | grep :PORT  # FreeBSD

# 测试端口连接
nc -z localhost PORT
curl -I http://localhost:PORT

# 查看服务状态
./status-server.sh -v
```

---

## 🎛️ 管理工具适配

### 服务助手工具

`server-helper.sh` 中的故障排除功能已适配新的端口处理逻辑：

```bash
./server-helper.sh

# 选择 "7. 🔧 故障排除"
# 选择 "1. 检查端口占用"
```

### 端口配置测试

```bash
# 运行端口配置测试（已更新为严格模式）
./test-port-config.sh
```

### 兼容性测试

```bash
# FreeBSD 兼容性测试
./test-freebsd-compatibility.sh
```

---

## 📊 配置最佳实践

### 1. 端口选择建议

```bash
# 推荐端口范围
开发环境: 3000-3999
测试环境: 4000-4999
预发布环境: 5000-5999
生产环境: 8000-8999

# 避免使用的端口
22    # SSH
80    # HTTP
443   # HTTPS
3306  # MySQL
5432  # PostgreSQL
```

### 2. 配置管理

```bash
# 1. 使用配置文件管理端口
vim demo-config.json

# 2. 使用环境变量（可选）
export CUSTOM_PORT=8080

# 3. 使用配置更新工具
./update-port-config.sh . 8080
```

### 3. 部署前检查

```bash
# 1. 检查端口可用性
netstat -tuln | grep :8080

# 2. 测试端口连接
nc -z localhost 8080

# 3. 运行兼容性测试
./test-freebsd-compatibility.sh
```

---

## 🔄 迁移指南

### 从智能端口模式迁移

如果您之前使用的是智能端口模式，请注意以下变更：

#### 1. 行为变更

**之前**:
- 端口被占用时自动建议可用端口
- 可以选择使用建议的端口
- 自动切换到可用端口

**现在**:
- 端口被占用时显示错误信息
- 提供手动解决方案
- 严格使用配置的端口

#### 2. 配置检查

```bash
# 检查当前配置的端口
grep '"port"' demo-config.json

# 确保端口可用
netstat -tuln | grep :$(grep '"port"' demo-config.json | sed 's/.*: *\([0-9]*\).*/\1/')
```

#### 3. 脚本更新

如果您有自定义脚本依赖智能端口功能，请更新：

```bash
# 移除对 suggest_available_port 的调用
# 移除对 find_available_port 的依赖
# 使用 check_port_available 进行端口检查
```

---

## 🎯 优势和限制

### 优势

- ✅ **配置一致性**: 确保使用预期的端口
- ✅ **可预测性**: 行为更加可预测
- ✅ **简化逻辑**: 减少复杂的端口选择逻辑
- ✅ **明确错误**: 清晰的错误信息和解决方案

### 限制

- ⚠️ **手动干预**: 端口冲突需要手动解决
- ⚠️ **部署复杂性**: 可能需要更多的部署前检查
- ⚠️ **用户体验**: 需要用户更多的配置管理

---

## 📚 相关文档

- [PORT_CONFIGURATION_GUIDE.md](PORT_CONFIGURATION_GUIDE.md) - 端口配置详细指南
- [DAEMON_MODE_GUIDE.md](DAEMON_MODE_GUIDE.md) - 后台运行模式指南
- [SERV00_TECHNICAL_ANALYSIS.md](SERV00_TECHNICAL_ANALYSIS.md) - 技术分析报告

---

## 🆘 技术支持

如果您在使用严格端口模式时遇到问题：

1. **查看日志**: `./manage-logs.sh view error`
2. **运行诊断**: `./server-helper.sh` → 故障排除
3. **检查兼容性**: `./test-freebsd-compatibility.sh`
4. **查看状态**: `./status-server.sh -v`

---

**📅 文档更新时间**: 2025-01-10  
**🔄 适用版本**: v2.1.0+  
**🌐 平台支持**: Serv00 FreeBSD  
**👨‍💻 技术支持**: Augment Agent
