<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é—´æ¥ç½‘ç»œæ£€æµ‹æ–¹æ³•æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 15px 0;
            border-radius: 8px;
            border-left: 4px solid #6f42c1;
        }
        .result {
            margin-top: 10px;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        .success { background-color: #d4edda; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; border: 1px solid #f5c6cb; }
        .warning { background-color: #fff3cd; border: 1px solid #ffeaa7; }
        .info { background-color: #d1ecf1; border: 1px solid #bee5eb; }
        button {
            background-color: #6f42c1;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background-color: #5a32a3; }
        button:disabled { background-color: #6c757d; cursor: not-allowed; }
        .log {
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            margin-top: 10px;
        }
        .url-input {
            width: 100%;
            padding: 8px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <h1>é—´æ¥ç½‘ç»œæ£€æµ‹æ–¹æ³•æŠ€æœ¯éªŒè¯</h1>
    <p><strong>ç›®æ ‡ï¼š</strong>æ¢ç´¢ç»•è¿‡æ··åˆå†…å®¹é™åˆ¶çš„é—´æ¥æ£€æµ‹æ–¹æ³•</p>
    <p><strong>å½“å‰é¡µé¢åè®®ï¼š</strong><span id="protocol"></span></p>

    <div class="test-section">
        <h3>æµ‹è¯•ç›®æ ‡é…ç½®</h3>
        <input type="text" id="target-host" class="url-input" placeholder="ç›®æ ‡ä¸»æœº (å¦‚: 10.0.0.192)" value="10.0.0.192">
        <input type="text" id="target-port" class="url-input" placeholder="ç›®æ ‡ç«¯å£ (å¦‚: 10800)" value="10800">
        <p><strong>å®Œæ•´URLï¼š</strong><span id="full-url">http://10.0.0.192:10800/</span></p>
    </div>

    <div class="grid">
        <div class="test-section">
            <h3>1. å›¾ç‰‡èµ„æºæ¢æµ‹</h3>
            <p>é€šè¿‡å›¾ç‰‡åŠ è½½æ£€æµ‹æœåŠ¡å¯è¾¾æ€§</p>
            <button onclick="testImageProbe()">æµ‹è¯•å›¾ç‰‡æ¢æµ‹</button>
            <div id="image-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>2. è„šæœ¬èµ„æºæ¢æµ‹</h3>
            <p>é€šè¿‡è„šæœ¬åŠ è½½æ£€æµ‹æœåŠ¡å¯è¾¾æ€§</p>
            <button onclick="testScriptProbe()">æµ‹è¯•è„šæœ¬æ¢æµ‹</button>
            <div id="script-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>3. CSSèµ„æºæ¢æµ‹</h3>
            <p>é€šè¿‡CSSåŠ è½½æ£€æµ‹æœåŠ¡å¯è¾¾æ€§</p>
            <button onclick="testCSSProbe()">æµ‹è¯•CSSæ¢æµ‹</button>
            <div id="css-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>4. iframeæ¢æµ‹</h3>
            <p>é€šè¿‡iframeåŠ è½½æ£€æµ‹æœåŠ¡å¯è¾¾æ€§</p>
            <button onclick="testIframeProbe()">æµ‹è¯•iframeæ¢æµ‹</button>
            <div id="iframe-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>5. WebSocketæ¢æµ‹</h3>
            <p>é€šè¿‡WebSocketè¿æ¥æ£€æµ‹æœåŠ¡å¯è¾¾æ€§</p>
            <button onclick="testWebSocketProbe()">æµ‹è¯•WebSocketæ¢æµ‹</button>
            <div id="websocket-result" class="result"></div>
        </div>

        <div class="test-section">
            <h3>6. æ—¶é—´å·®åˆ†æ</h3>
            <p>é€šè¿‡è¯·æ±‚æ—¶é—´å·®åˆ†ææœåŠ¡çŠ¶æ€</p>
            <button onclick="testTimingAnalysis()">æµ‹è¯•æ—¶é—´å·®åˆ†æ</button>
            <div id="timing-result" class="result"></div>
        </div>
    </div>

    <div class="test-section">
        <h3>7. ç»¼åˆæ£€æµ‹ç­–ç•¥</h3>
        <p>ç»“åˆå¤šç§æ–¹æ³•è¿›è¡Œç»¼åˆæ£€æµ‹</p>
        <button onclick="testComprehensiveDetection()">è¿è¡Œç»¼åˆæ£€æµ‹</button>
        <div id="comprehensive-result" class="result"></div>
    </div>

    <div class="test-section">
        <h3>æµ‹è¯•æ—¥å¿—</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        document.getElementById('protocol').textContent = window.location.protocol;

        function updateFullUrl() {
            const host = document.getElementById('target-host').value;
            const port = document.getElementById('target-port').value;
            const fullUrl = `http://${host}:${port}/`;
            document.getElementById('full-url').textContent = fullUrl;
            return fullUrl;
        }

        document.getElementById('target-host').addEventListener('input', updateFullUrl);
        document.getElementById('target-port').addEventListener('input', updateFullUrl);

        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.textContent += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').textContent = '';
        }

        function getTargetUrl() {
            return updateFullUrl();
        }

        // 1. å›¾ç‰‡èµ„æºæ¢æµ‹
        function testImageProbe() {
            const resultDiv = document.getElementById('image-result');
            const baseUrl = getTargetUrl();

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿›è¡Œå›¾ç‰‡æ¢æµ‹...';

            const imagePaths = [
                'favicon.ico',
                'favicon.png',
                'logo.png',
                'apple-touch-icon.png',
                'robots.txt', // è™½ç„¶ä¸æ˜¯å›¾ç‰‡ï¼Œä½†å¯ä»¥é€šè¿‡Imageå¯¹è±¡å°è¯•åŠ è½½
                'manifest.json'
            ];

            let successCount = 0;
            let errorCount = 0;
            let totalTests = imagePaths.length;
            const results = [];

            imagePaths.forEach((path, index) => {
                const img = new Image();
                const startTime = Date.now();
                const testUrl = baseUrl + path;

                img.onload = () => {
                    const responseTime = Date.now() - startTime;
                    successCount++;
                    results.push(`âœ… ${path}: åŠ è½½æˆåŠŸ (${responseTime}ms)`);
                    log(`å›¾ç‰‡æ¢æµ‹æˆåŠŸ: ${testUrl} (${responseTime}ms)`);
                    updateImageResult();
                };

                img.onerror = () => {
                    const responseTime = Date.now() - startTime;
                    errorCount++;
                    results.push(`âŒ ${path}: åŠ è½½å¤±è´¥ (${responseTime}ms)`);
                    log(`å›¾ç‰‡æ¢æµ‹å¤±è´¥: ${testUrl} (${responseTime}ms)`);
                    updateImageResult();
                };

                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    if (!img.complete) {
                        errorCount++;
                        results.push(`â° ${path}: è¶…æ—¶`);
                        updateImageResult();
                    }
                }, 5000);

                img.src = testUrl + '?_t=' + Date.now();
            });

            function updateImageResult() {
                if (successCount + errorCount >= totalTests) {
                    if (successCount > 0) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent =
                            `âœ… å›¾ç‰‡æ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `ç»“æœè¡¨æ˜æœåŠ¡å¯èƒ½åœ¨çº¿\n\n` +
                            results.join('\n');
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent =
                            `âŒ å›¾ç‰‡æ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `æœåŠ¡å¯èƒ½ç¦»çº¿æˆ–ä¸æ”¯æŒè¿™äº›èµ„æº\n\n` +
                            results.join('\n');
                    }
                }
            }
        }

        // 2. è„šæœ¬èµ„æºæ¢æµ‹
        function testScriptProbe() {
            const resultDiv = document.getElementById('script-result');
            const baseUrl = getTargetUrl();

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿›è¡Œè„šæœ¬æ¢æµ‹...';

            const scriptPaths = [
                'js/app.js',
                'js/main.js',
                'static/js/main.js',
                'assets/js/app.js',
                'script.js'
            ];

            let successCount = 0;
            let errorCount = 0;
            let totalTests = scriptPaths.length;
            const results = [];

            scriptPaths.forEach((path, index) => {
                const script = document.createElement('script');
                const startTime = Date.now();
                const testUrl = baseUrl + path;

                script.onload = () => {
                    const responseTime = Date.now() - startTime;
                    successCount++;
                    results.push(`âœ… ${path}: åŠ è½½æˆåŠŸ (${responseTime}ms)`);
                    log(`è„šæœ¬æ¢æµ‹æˆåŠŸ: ${testUrl} (${responseTime}ms)`);
                    updateScriptResult();
                    document.head.removeChild(script);
                };

                script.onerror = () => {
                    const responseTime = Date.now() - startTime;
                    errorCount++;
                    results.push(`âŒ ${path}: åŠ è½½å¤±è´¥ (${responseTime}ms)`);
                    log(`è„šæœ¬æ¢æµ‹å¤±è´¥: ${testUrl} (${responseTime}ms)`);
                    updateScriptResult();
                    document.head.removeChild(script);
                };

                script.src = testUrl + '?_t=' + Date.now();
                document.head.appendChild(script);

                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    if (script.parentNode) {
                        errorCount++;
                        results.push(`â° ${path}: è¶…æ—¶`);
                        updateScriptResult();
                        document.head.removeChild(script);
                    }
                }, 5000);
            });

            function updateScriptResult() {
                if (successCount + errorCount >= totalTests) {
                    if (successCount > 0) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent =
                            `âœ… è„šæœ¬æ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `ç»“æœè¡¨æ˜æœåŠ¡å¯èƒ½åœ¨çº¿\n\n` +
                            results.join('\n');
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent =
                            `âŒ è„šæœ¬æ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `æœåŠ¡å¯èƒ½ç¦»çº¿æˆ–ä¸æ”¯æŒè¿™äº›èµ„æº\n\n` +
                            results.join('\n');
                    }
                }
            }
        }

        // 3. CSSèµ„æºæ¢æµ‹
        function testCSSProbe() {
            const resultDiv = document.getElementById('css-result');
            const baseUrl = getTargetUrl();

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿›è¡ŒCSSæ¢æµ‹...';

            const cssPaths = [
                'css/style.css',
                'css/main.css',
                'static/css/main.css',
                'assets/css/app.css',
                'style.css'
            ];

            let successCount = 0;
            let errorCount = 0;
            let totalTests = cssPaths.length;
            const results = [];

            cssPaths.forEach((path, index) => {
                const link = document.createElement('link');
                const startTime = Date.now();
                const testUrl = baseUrl + path;

                link.rel = 'stylesheet';
                link.type = 'text/css';

                link.onload = () => {
                    const responseTime = Date.now() - startTime;
                    successCount++;
                    results.push(`âœ… ${path}: åŠ è½½æˆåŠŸ (${responseTime}ms)`);
                    log(`CSSæ¢æµ‹æˆåŠŸ: ${testUrl} (${responseTime}ms)`);
                    updateCSSResult();
                    document.head.removeChild(link);
                };

                link.onerror = () => {
                    const responseTime = Date.now() - startTime;
                    errorCount++;
                    results.push(`âŒ ${path}: åŠ è½½å¤±è´¥ (${responseTime}ms)`);
                    log(`CSSæ¢æµ‹å¤±è´¥: ${testUrl} (${responseTime}ms)`);
                    updateCSSResult();
                    document.head.removeChild(link);
                };

                link.href = testUrl + '?_t=' + Date.now();
                document.head.appendChild(link);

                // è®¾ç½®è¶…æ—¶
                setTimeout(() => {
                    if (link.parentNode) {
                        errorCount++;
                        results.push(`â° ${path}: è¶…æ—¶`);
                        updateCSSResult();
                        document.head.removeChild(link);
                    }
                }, 5000);
            });

            function updateCSSResult() {
                if (successCount + errorCount >= totalTests) {
                    if (successCount > 0) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent =
                            `âœ… CSSæ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `ç»“æœè¡¨æ˜æœåŠ¡å¯èƒ½åœ¨çº¿\n\n` +
                            results.join('\n');
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent =
                            `âŒ CSSæ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `æœåŠ¡å¯èƒ½ç¦»çº¿æˆ–ä¸æ”¯æŒè¿™äº›èµ„æº\n\n` +
                            results.join('\n');
                    }
                }
            }
        }

        // 4. iframeæ¢æµ‹
        function testIframeProbe() {
            const resultDiv = document.getElementById('iframe-result');
            const baseUrl = getTargetUrl();

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿›è¡Œiframeæ¢æµ‹...';

            const iframe = document.createElement('iframe');
            const startTime = Date.now();

            iframe.style.display = 'none';
            iframe.src = baseUrl + '?_t=' + Date.now();

            let completed = false;

            iframe.onload = () => {
                if (!completed) {
                    completed = true;
                    const responseTime = Date.now() - startTime;
                    resultDiv.className = 'result success';
                    resultDiv.textContent =
                        `âœ… iframeæ¢æµ‹æˆåŠŸ\n` +
                        `URL: ${baseUrl}\n` +
                        `å“åº”æ—¶é—´: ${responseTime}ms\n` +
                        `æœåŠ¡å¯èƒ½åœ¨çº¿`;
                    log(`iframeæ¢æµ‹æˆåŠŸ: ${baseUrl} (${responseTime}ms)`);
                    document.body.removeChild(iframe);
                }
            };

            iframe.onerror = () => {
                if (!completed) {
                    completed = true;
                    const responseTime = Date.now() - startTime;
                    resultDiv.className = 'result error';
                    resultDiv.textContent =
                        `âŒ iframeæ¢æµ‹å¤±è´¥\n` +
                        `URL: ${baseUrl}\n` +
                        `å“åº”æ—¶é—´: ${responseTime}ms\n` +
                        `æœåŠ¡å¯èƒ½ç¦»çº¿`;
                    log(`iframeæ¢æµ‹å¤±è´¥: ${baseUrl} (${responseTime}ms)`);
                    document.body.removeChild(iframe);
                }
            };

            document.body.appendChild(iframe);

            // è®¾ç½®è¶…æ—¶
            setTimeout(() => {
                if (!completed) {
                    completed = true;
                    resultDiv.className = 'result warning';
                    resultDiv.textContent =
                        `â° iframeæ¢æµ‹è¶…æ—¶\n` +
                        `URL: ${baseUrl}\n` +
                        `å¯èƒ½ç”±äºæ··åˆå†…å®¹é™åˆ¶æˆ–æœåŠ¡å“åº”æ…¢`;
                    log(`iframeæ¢æµ‹è¶…æ—¶: ${baseUrl}`);
                    document.body.removeChild(iframe);
                }
            }, 10000);
        }

        // 5. WebSocketæ¢æµ‹
        function testWebSocketProbe() {
            const resultDiv = document.getElementById('websocket-result');
            const host = document.getElementById('target-host').value;
            const port = document.getElementById('target-port').value;

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿›è¡ŒWebSocketæ¢æµ‹...';

            // å°è¯•ä¸åŒçš„WebSocketåè®®
            const wsUrls = [
                `ws://${host}:${port}/`,
                `ws://${host}:${port}/ws`,
                `ws://${host}:${port}/websocket`,
                `wss://${host}:${port}/`,
                `wss://${host}:${port}/ws`
            ];

            let successCount = 0;
            let errorCount = 0;
            let totalTests = wsUrls.length;
            const results = [];

            wsUrls.forEach((wsUrl, index) => {
                const startTime = Date.now();

                try {
                    const ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        const responseTime = Date.now() - startTime;
                        successCount++;
                        results.push(`âœ… ${wsUrl}: è¿æ¥æˆåŠŸ (${responseTime}ms)`);
                        log(`WebSocketè¿æ¥æˆåŠŸ: ${wsUrl} (${responseTime}ms)`);
                        ws.close();
                        updateWSResult();
                    };

                    ws.onerror = () => {
                        const responseTime = Date.now() - startTime;
                        errorCount++;
                        results.push(`âŒ ${wsUrl}: è¿æ¥å¤±è´¥ (${responseTime}ms)`);
                        log(`WebSocketè¿æ¥å¤±è´¥: ${wsUrl} (${responseTime}ms)`);
                        updateWSResult();
                    };

                    ws.onclose = () => {
                        // è¿æ¥å…³é—­ï¼Œä½†è¿™å¯èƒ½æ„å‘³ç€æœåŠ¡å™¨å­˜åœ¨
                        if (ws.readyState === WebSocket.CLOSED && !results.some(r => r.includes(wsUrl))) {
                            const responseTime = Date.now() - startTime;
                            errorCount++;
                            results.push(`ğŸ”’ ${wsUrl}: è¿æ¥è¢«å…³é—­ (${responseTime}ms)`);
                            log(`WebSocketè¿æ¥è¢«å…³é—­: ${wsUrl} (${responseTime}ms)`);
                            updateWSResult();
                        }
                    };

                    // è®¾ç½®è¶…æ—¶
                    setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING) {
                            ws.close();
                            errorCount++;
                            results.push(`â° ${wsUrl}: è¿æ¥è¶…æ—¶`);
                            updateWSResult();
                        }
                    }, 5000);

                } catch (error) {
                    errorCount++;
                    results.push(`âŒ ${wsUrl}: å¼‚å¸¸ - ${error.message}`);
                    log(`WebSocketå¼‚å¸¸: ${wsUrl} - ${error.message}`);
                    updateWSResult();
                }
            });

            function updateWSResult() {
                if (successCount + errorCount >= totalTests) {
                    if (successCount > 0) {
                        resultDiv.className = 'result success';
                        resultDiv.textContent =
                            `âœ… WebSocketæ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `å‘ç°WebSocketæœåŠ¡\n\n` +
                            results.join('\n');
                    } else {
                        resultDiv.className = 'result error';
                        resultDiv.textContent =
                            `âŒ WebSocketæ¢æµ‹å®Œæˆ\n` +
                            `æˆåŠŸ: ${successCount}/${totalTests}\n` +
                            `æœªå‘ç°WebSocketæœåŠ¡\n\n` +
                            results.join('\n');
                    }
                }
            }
        }

        // 6. æ—¶é—´å·®åˆ†æ
        function testTimingAnalysis() {
            const resultDiv = document.getElementById('timing-result');
            const baseUrl = getTargetUrl();

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿›è¡Œæ—¶é—´å·®åˆ†æ...';

            const tests = [];
            const testCount = 5;

            // è¿›è¡Œå¤šæ¬¡æµ‹è¯•ä»¥åˆ†ææ—¶é—´æ¨¡å¼
            for (let i = 0; i < testCount; i++) {
                setTimeout(() => {
                    const img = new Image();
                    const startTime = performance.now();

                    img.onload = () => {
                        const responseTime = performance.now() - startTime;
                        tests.push({ success: true, time: responseTime });
                        checkTimingComplete();
                    };

                    img.onerror = () => {
                        const responseTime = performance.now() - startTime;
                        tests.push({ success: false, time: responseTime });
                        checkTimingComplete();
                    };

                    img.src = baseUrl + 'favicon.ico?_t=' + Date.now() + '_' + i;
                }, i * 200);
            }

            function checkTimingComplete() {
                if (tests.length >= testCount) {
                    const successTimes = tests.filter(t => t.success).map(t => t.time);
                    const errorTimes = tests.filter(t => !t.success).map(t => t.time);

                    const avgSuccessTime = successTimes.length > 0 ?
                        successTimes.reduce((a, b) => a + b, 0) / successTimes.length : 0;
                    const avgErrorTime = errorTimes.length > 0 ?
                        errorTimes.reduce((a, b) => a + b, 0) / errorTimes.length : 0;

                    let analysis = '';
                    if (successTimes.length > 0) {
                        analysis = `âœ… æ£€æµ‹åˆ°æˆåŠŸå“åº”\nå¹³å‡å“åº”æ—¶é—´: ${avgSuccessTime.toFixed(2)}ms`;
                        resultDiv.className = 'result success';
                    } else if (errorTimes.length > 0) {
                        if (avgErrorTime < 100) {
                            analysis = `âš ï¸ å¿«é€Ÿå¤±è´¥æ¨¡å¼\nå¹³å‡å¤±è´¥æ—¶é—´: ${avgErrorTime.toFixed(2)}ms\nå¯èƒ½æ˜¯è¿æ¥è¢«æ‹’ç»ï¼ˆæœåŠ¡åœ¨çº¿ä½†æ‹’ç»è¿æ¥ï¼‰`;
                            resultDiv.className = 'result warning';
                        } else {
                            analysis = `âŒ æ…¢é€Ÿå¤±è´¥æ¨¡å¼\nå¹³å‡å¤±è´¥æ—¶é—´: ${avgErrorTime.toFixed(2)}ms\nå¯èƒ½æ˜¯è¶…æ—¶ï¼ˆæœåŠ¡ç¦»çº¿æˆ–ç½‘ç»œä¸å¯è¾¾ï¼‰`;
                            resultDiv.className = 'result error';
                        }
                    }

                    resultDiv.textContent =
                        `æ—¶é—´å·®åˆ†æå®Œæˆ\n` +
                        `æˆåŠŸ: ${successTimes.length}/${testCount}\n` +
                        `å¤±è´¥: ${errorTimes.length}/${testCount}\n\n` +
                        analysis + '\n\n' +
                        `è¯¦ç»†æ—¶é—´: ${tests.map(t => t.time.toFixed(1) + 'ms').join(', ')}`;

                    log(`æ—¶é—´å·®åˆ†æå®Œæˆ: æˆåŠŸ${successTimes.length}, å¤±è´¥${errorTimes.length}`);
                }
            }
        }

        // 7. ç»¼åˆæ£€æµ‹ç­–ç•¥
        async function testComprehensiveDetection() {
            const resultDiv = document.getElementById('comprehensive-result');
            const baseUrl = getTargetUrl();

            resultDiv.className = 'result info';
            resultDiv.textContent = 'æ­£åœ¨è¿è¡Œç»¼åˆæ£€æµ‹...';

            const detectionResults = {
                image: null,
                script: null,
                css: null,
                iframe: null,
                websocket: null,
                timing: null
            };

            // å›¾ç‰‡æ£€æµ‹
            await new Promise(resolve => {
                const img = new Image();
                const startTime = Date.now();

                img.onload = () => {
                    detectionResults.image = { success: true, time: Date.now() - startTime };
                    resolve();
                };

                img.onerror = () => {
                    detectionResults.image = { success: false, time: Date.now() - startTime };
                    resolve();
                };

                setTimeout(() => {
                    detectionResults.image = { success: false, time: Date.now() - startTime, timeout: true };
                    resolve();
                }, 3000);

                img.src = baseUrl + 'favicon.ico?_t=' + Date.now();
            });

            // è„šæœ¬æ£€æµ‹
            await new Promise(resolve => {
                const script = document.createElement('script');
                const startTime = Date.now();

                script.onload = () => {
                    detectionResults.script = { success: true, time: Date.now() - startTime };
                    document.head.removeChild(script);
                    resolve();
                };

                script.onerror = () => {
                    detectionResults.script = { success: false, time: Date.now() - startTime };
                    document.head.removeChild(script);
                    resolve();
                };

                setTimeout(() => {
                    if (script.parentNode) {
                        detectionResults.script = { success: false, time: Date.now() - startTime, timeout: true };
                        document.head.removeChild(script);
                        resolve();
                    }
                }, 3000);

                script.src = baseUrl + 'js/app.js?_t=' + Date.now();
                document.head.appendChild(script);
            });

            // WebSocketæ£€æµ‹
            await new Promise(resolve => {
                const host = document.getElementById('target-host').value;
                const port = document.getElementById('target-port').value;
                const wsUrl = `ws://${host}:${port}/`;
                const startTime = Date.now();

                try {
                    const ws = new WebSocket(wsUrl);

                    ws.onopen = () => {
                        detectionResults.websocket = { success: true, time: Date.now() - startTime };
                        ws.close();
                        resolve();
                    };

                    ws.onerror = () => {
                        detectionResults.websocket = { success: false, time: Date.now() - startTime };
                        resolve();
                    };

                    setTimeout(() => {
                        if (ws.readyState === WebSocket.CONNECTING) {
                            ws.close();
                            detectionResults.websocket = { success: false, time: Date.now() - startTime, timeout: true };
                            resolve();
                        }
                    }, 3000);

                } catch (error) {
                    detectionResults.websocket = { success: false, time: 0, error: error.message };
                    resolve();
                }
            });

            // åˆ†æç»¼åˆç»“æœ
            const successCount = Object.values(detectionResults).filter(r => r && r.success).length;
            const totalTests = Object.keys(detectionResults).length;

            let conclusion = '';
            let resultClass = '';

            if (successCount > 0) {
                conclusion = `ğŸ¯ æœåŠ¡å¯èƒ½åœ¨çº¿\næ£€æµ‹åˆ° ${successCount}/${totalTests} ç§æ–¹æ³•æˆåŠŸ`;
                resultClass = 'result success';
            } else {
                const fastFailures = Object.values(detectionResults).filter(r => r && !r.success && r.time < 100).length;
                if (fastFailures > totalTests / 2) {
                    conclusion = `âš ï¸ æœåŠ¡å¯èƒ½åœ¨çº¿ä½†æ‹’ç»è¿æ¥\nå¤šæ•°æ£€æµ‹å¿«é€Ÿå¤±è´¥ï¼Œè¡¨æ˜ç½‘ç»œå¯è¾¾ä½†æœåŠ¡æ‹’ç»`;
                    resultClass = 'result warning';
                } else {
                    conclusion = `âŒ æœåŠ¡å¯èƒ½ç¦»çº¿\næ‰€æœ‰æ£€æµ‹æ–¹æ³•å‡å¤±è´¥`;
                    resultClass = 'result error';
                }
            }

            resultDiv.className = resultClass;
            resultDiv.textContent =
                `ç»¼åˆæ£€æµ‹å®Œæˆ\n\n` +
                conclusion + '\n\n' +
                `è¯¦ç»†ç»“æœ:\n` +
                `å›¾ç‰‡æ¢æµ‹: ${detectionResults.image?.success ? 'âœ…' : 'âŒ'} (${detectionResults.image?.time || 0}ms)\n` +
                `è„šæœ¬æ¢æµ‹: ${detectionResults.script?.success ? 'âœ…' : 'âŒ'} (${detectionResults.script?.time || 0}ms)\n` +
                `WebSocket: ${detectionResults.websocket?.success ? 'âœ…' : 'âŒ'} (${detectionResults.websocket?.time || 0}ms)`;

            log(`ç»¼åˆæ£€æµ‹å®Œæˆ: ${successCount}/${totalTests} æˆåŠŸ`);
        }

        // é¡µé¢åŠ è½½æ—¶çš„åˆå§‹åŒ–
        window.onload = () => {
            log('é¡µé¢åŠ è½½å®Œæˆ');
            log(`å½“å‰åè®®: ${window.location.protocol}`);
            updateFullUrl();

            // æ£€æŸ¥å„ç§APIæ”¯æŒ
            log(`WebSocketæ”¯æŒ: ${typeof WebSocket !== 'undefined' ? 'âœ…' : 'âŒ'}`);
            log(`Performance APIæ”¯æŒ: ${typeof performance !== 'undefined' ? 'âœ…' : 'âŒ'}`);
        };
    </script>
</body>
</html>