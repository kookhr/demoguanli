<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>路由测试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            margin: 10px;
            font-size: 16px;
            display: block;
            width: 100%;
        }
        .button:hover {
            background: #1d4ed8;
        }
        .result {
            margin-top: 20px;
            padding: 20px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .result.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .result.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .result.info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .link-test {
            margin: 10px 0;
            padding: 10px;
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 4px;
        }
        .link-test a {
            color: #2563eb;
            text-decoration: none;
            font-weight: bold;
        }
        .link-test a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔄 全面路由诊断工具</h1>
            <p>诊断和修复网站路由配置问题</p>
        </div>

        <button class="button" onclick="testRouting()">🚀 完整路由测试</button>
        <button class="button" onclick="testResourceLoading()">📦 资源加载测试</button>
        <button class="button" onclick="testRedirectLoop()">🔄 重定向循环检测</button>
        
        <div class="link-test">
            <strong>手动测试链接：</strong><br>
            <a href="/" target="_blank">根目录 (/) - 应该加载 dist/index.html</a><br>
            <a href="/dist/index.html" target="_blank">直接访问 dist/index.html</a><br>
            <a href="/index.html" target="_blank">根目录 index.html (开发版本)</a><br>
            <a href="/api/health" target="_blank">API健康检查</a>
        </div>
        
        <div id="result" class="result" style="display: none;"></div>
    </div>

    <script>
        function showResult(content, type = 'info') {
            const element = document.getElementById('result');
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
        }

        // 新增：资源加载测试
        async function testResourceLoading() {
            showResult('正在测试资源加载...', 'info');

            let report = '📦 资源加载测试报告\n';
            report += '=' .repeat(50) + '\n\n';

            // 测试关键资源文件
            const resources = [
                { path: '/dist/assets/index-CmRkGmP_.js', type: 'JavaScript', expected: 'application/javascript' },
                { path: '/dist/assets/index-CmQAOyIr.css', type: 'CSS', expected: 'text/css' },
                { path: '/dist/K.svg', type: 'SVG', expected: 'image/svg+xml' },
                { path: '/src/main.jsx', type: 'JSX源文件', expected: 'application/javascript' },
                { path: '/api/health', type: 'API端点', expected: 'application/json' }
            ];

            report += '1️⃣ 关键资源检查:\n';

            for (const resource of resources) {
                try {
                    const response = await fetch(resource.path, { method: 'HEAD' });
                    const contentType = response.headers.get('content-type');

                    if (response.ok) {
                        if (contentType && contentType.includes(resource.expected.split('/')[1])) {
                            report += `   ✅ ${resource.type}: ${resource.path} (${contentType})\n`;
                        } else {
                            report += `   ❌ ${resource.type}: ${resource.path} - 错误MIME类型: ${contentType}\n`;
                        }
                    } else {
                        report += `   ❌ ${resource.type}: ${resource.path} - HTTP ${response.status}\n`;
                    }
                } catch (error) {
                    report += `   ❌ ${resource.type}: ${resource.path} - 连接错误\n`;
                }
            }

            report += '\n2️⃣ 资源加载建议:\n';
            report += '   • 如果JavaScript文件MIME类型错误，检查.htaccess配置\n';
            report += '   • 如果资源404，检查文件是否存在和路径是否正确\n';
            report += '   • 如果API端点失败，检查PHP配置\n';

            showResult(report, 'info');
        }

        // 新增：重定向循环检测
        async function testRedirectLoop() {
            showResult('正在检测重定向循环...', 'info');

            let report = '🔄 重定向循环检测报告\n';
            report += '=' .repeat(50) + '\n\n';

            const testPaths = ['/', '/dist/index.html', '/some-spa-route'];

            for (const path of testPaths) {
                try {
                    const response = await fetch(path, {
                        method: 'GET',
                        redirect: 'manual'  // 不自动跟随重定向
                    });

                    if (response.status >= 300 && response.status < 400) {
                        const location = response.headers.get('location');
                        report += `   🔄 ${path}: 重定向到 ${location} (${response.status})\n`;

                        // 检查是否是循环重定向
                        if (location === path) {
                            report += `   ❌ 检测到循环重定向: ${path} → ${location}\n`;
                        }
                    } else if (response.ok) {
                        report += `   ✅ ${path}: 正常响应 (${response.status})\n`;
                    } else {
                        report += `   ❌ ${path}: 错误响应 (${response.status})\n`;
                    }
                } catch (error) {
                    report += `   ❌ ${path}: 检测失败 - ${error.message}\n`;
                }
            }

            report += '\n💡 修复建议:\n';
            report += '   • 如果检测到循环重定向，检查.htaccess重写规则\n';
            report += '   • 确保重定向目标路径正确且可访问\n';
            report += '   • 使用302重定向而不是内部重写避免循环\n';

            showResult(report, 'info');
        }

        async function testRouting() {
            showResult('正在进行完整路由测试...', 'info');

            let report = '🔄 完整路由配置测试报告\n';
            report += '=' .repeat(50) + '\n\n';
            
            // 1. 检测当前页面环境
            report += '1️⃣ 当前页面环境检测:\n';
            report += `   当前URL: ${window.location.href}\n`;
            
            // 检查页面资源
            const scripts = document.querySelectorAll('script[src]');
            const stylesheets = document.querySelectorAll('link[rel="stylesheet"]');
            
            let isProduction = false;
            let isDevelopment = false;
            
            scripts.forEach(script => {
                if (script.src.includes('/src/') || script.src.includes('main.jsx')) {
                    isDevelopment = true;
                    report += `   ❌ 检测到开发资源: ${script.src}\n`;
                } else if (script.src.includes('assets/') || script.src.includes('/dist/')) {
                    isProduction = true;
                    report += `   ✅ 检测到生产资源: ${script.src}\n`;
                }
            });
            
            if (isProduction) {
                report += '   ✅ 当前使用生产环境 (正确)\n';
            } else if (isDevelopment) {
                report += '   ❌ 当前使用开发环境 (路由配置问题)\n';
            } else {
                report += '   ⚠️ 无法确定当前环境\n';
            }
            
            // 2. 测试不同路径的响应
            report += '\n2️⃣ 路径响应测试:\n';
            
            const pathTests = [
                { path: '/', description: '根目录' },
                { path: '/dist/index.html', description: '生产版本' },
                { path: '/index.html', description: '开发版本' },
                { path: '/api/health', description: 'API端点' }
            ];
            
            for (const test of pathTests) {
                try {
                    const response = await fetch(test.path, { method: 'HEAD' });
                    const contentType = response.headers.get('content-type');
                    
                    if (response.ok) {
                        report += `   ✅ ${test.path}: ${response.status} (${contentType})\n`;
                    } else {
                        report += `   ❌ ${test.path}: ${response.status} ${response.statusText}\n`;
                    }
                } catch (error) {
                    report += `   ❌ ${test.path}: 连接错误 - ${error.message}\n`;
                }
            }
            
            // 3. 检查文件存在性
            report += '\n3️⃣ 文件存在性检查:\n';
            
            const fileTests = [
                'dist/index.html',
                'dist/assets/index-CmRkGmP_.js',
                'dist/assets/index-CmQAOyIr.css'
            ];
            
            for (const file of fileTests) {
                try {
                    const response = await fetch(file, { method: 'HEAD' });
                    if (response.ok) {
                        report += `   ✅ ${file}: 存在\n`;
                    } else {
                        report += `   ❌ ${file}: 不存在 (${response.status})\n`;
                    }
                } catch (error) {
                    report += `   ❌ ${file}: 检查失败 - ${error.message}\n`;
                }
            }
            
            // 4. 路由诊断
            report += '\n4️⃣ 路由诊断:\n';
            
            if (isDevelopment && !isProduction) {
                report += '   ❌ 问题: 根目录仍在使用开发版本\n';
                report += '   💡 解决方案:\n';
                report += '     1. 检查 .htaccess 配置是否生效\n';
                report += '     2. 确认 dist/index.html 文件存在\n';
                report += '     3. 验证服务器是否支持 mod_rewrite\n';
                report += '     4. 尝试强制刷新浏览器缓存\n';
            } else if (isProduction) {
                report += '   ✅ 路由配置正常，正在使用生产版本\n';
            } else {
                report += '   ⚠️ 无法确定路由状态，需要进一步检查\n';
            }
            
            // 5. 建议的修复步骤
            report += '\n5️⃣ 建议的修复步骤:\n';
            if (isDevelopment) {
                report += '   1. 清除浏览器缓存并强制刷新 (Ctrl+F5)\n';
                report += '   2. 检查 .htaccess 文件是否正确上传\n';
                report += '   3. 验证 dist 目录和文件权限\n';
                report += '   4. 联系 Serv00 技术支持检查 mod_rewrite 配置\n';
            } else {
                report += '   • 路由配置看起来正常\n';
                report += '   • 如果仍有问题，请检查具体的错误信息\n';
            }
            
            report += `\n📅 测试时间: ${new Date().toLocaleString()}`;
            
            const resultType = isProduction ? 'success' : (isDevelopment ? 'error' : 'info');
            showResult(report, resultType);
        }

        // 页面加载时自动运行测试
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔄 路由测试页面已加载');
            
            // 自动运行路由测试
            setTimeout(() => {
                testRouting();
            }, 1000);
        });
    </script>
</body>
</html>
