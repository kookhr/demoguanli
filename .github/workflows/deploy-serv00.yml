name: Deploy to Serv00

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
    types: [ closed ]

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # åªåœ¨ push åˆ°ä¸»åˆ†æ”¯æˆ– PR åˆå¹¶æ—¶éƒ¨ç½²
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
      
    - name: ğŸ“‹ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        
    - name: ğŸ“¦ Install dependencies
      run: npm ci
      
    - name: ğŸ” Run tests (if available)
      run: |
        if npm run test --if-present; then
          echo "âœ… Tests passed"
        else
          echo "âš ï¸ No tests found or tests failed"
        fi
      continue-on-error: true
      
    - name: ğŸ”¨ Build project
      run: npm run build
      
    - name: ğŸ“ Create .htaccess
      run: |
        cat > dist/.htaccess << 'EOF'
        # å¯ç”¨ Gzip å‹ç¼©
        <IfModule mod_deflate.c>
            AddOutputFilterByType DEFLATE text/plain
            AddOutputFilterByType DEFLATE text/html
            AddOutputFilterByType DEFLATE text/xml
            AddOutputFilterByType DEFLATE text/css
            AddOutputFilterByType DEFLATE application/xml
            AddOutputFilterByType DEFLATE application/xhtml+xml
            AddOutputFilterByType DEFLATE application/rss+xml
            AddOutputFilterByType DEFLATE application/javascript
            AddOutputFilterByType DEFLATE application/x-javascript
        </IfModule>

        # è®¾ç½®ç¼“å­˜
        <IfModule mod_expires.c>
            ExpiresActive on
            ExpiresByType text/css "access plus 1 year"
            ExpiresByType application/javascript "access plus 1 year"
            ExpiresByType image/png "access plus 1 year"
            ExpiresByType image/jpg "access plus 1 year"
            ExpiresByType image/jpeg "access plus 1 year"
            ExpiresByType image/gif "access plus 1 year"
            ExpiresByType image/svg+xml "access plus 1 year"
        </IfModule>

        # SPA è·¯ç”±æ”¯æŒ
        <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteRule ^index\.html$ - [L]
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
        </IfModule>

        # å®‰å…¨å¤´
        <IfModule mod_headers.c>
            Header always set X-Frame-Options DENY
            Header always set X-Content-Type-Options nosniff
            Header always set Referrer-Policy "strict-origin-when-cross-origin"
        </IfModule>
        EOF
        
    - name: ğŸ“¤ Deploy to Serv00
      uses: SamKirkland/FTP-Deploy-Action@v4.3.4
      with:
        server: ftp.serv00.com
        username: ${{ secrets.SERV00_USERNAME }}
        password: ${{ secrets.SERV00_PASSWORD }}
        local-dir: ./dist/
        server-dir: /domains/${{ secrets.SERV00_DOMAIN }}/public_html/
        exclude: |
          **/.git*
          **/.git*/**
          **/node_modules/**
          **/.DS_Store
          **/Thumbs.db
        
    - name: ğŸ” Verify deployment
      run: |
        echo "ğŸŒ ç½‘ç«™åœ°å€: https://${{ secrets.SERV00_DOMAIN }}"
        echo "ğŸ“Š éƒ¨ç½²ä¿¡æ¯:"
        echo "   - æäº¤: ${{ github.sha }}"
        echo "   - åˆ†æ”¯: ${{ github.ref_name }}"
        echo "   - æ—¶é—´: $(date)"
        
        # ç­‰å¾…å‡ ç§’è®©éƒ¨ç½²ç”Ÿæ•ˆ
        sleep 10
        
        # æ£€æŸ¥ç½‘ç«™æ˜¯å¦å¯è®¿é—®
        if curl -s --head "https://${{ secrets.SERV00_DOMAIN }}" | head -n 1 | grep -q "200\|301\|302"; then
          echo "âœ… ç½‘ç«™éƒ¨ç½²æˆåŠŸï¼Œå¯æ­£å¸¸è®¿é—®"
        else
          echo "âš ï¸ ç½‘ç«™å¯èƒ½éœ€è¦å‡ åˆ†é’Ÿæ‰èƒ½ç”Ÿæ•ˆ"
        fi
        
    - name: ğŸ“Š Deployment Summary
      run: |
        echo "## ğŸš€ éƒ¨ç½²å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| é¡¹ç›® | ä¿¡æ¯ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ ç½‘ç«™åœ°å€ | https://${{ secrets.SERV00_DOMAIN }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“ æäº¤ä¿¡æ¯ | ${{ github.event.head_commit.message }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ”— æäº¤å“ˆå¸Œ | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ¿ åˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
        echo "| â° éƒ¨ç½²æ—¶é—´ | $(date) |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“‹ éƒ¨ç½²æ­¥éª¤" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä»£ç æ£€å‡º" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Node.js ç¯å¢ƒè®¾ç½®" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… ä¾èµ–å®‰è£…" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… é¡¹ç›®æ„å»º" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… é…ç½®æ–‡ä»¶åˆ›å»º" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æ–‡ä»¶ä¸Šä¼ " >> $GITHUB_STEP_SUMMARY
        echo "- âœ… éƒ¨ç½²éªŒè¯" >> $GITHUB_STEP_SUMMARY

  # éƒ¨ç½²å¤±è´¥æ—¶çš„é€šçŸ¥ä»»åŠ¡
  notify-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    
    steps:
    - name: ğŸ“§ Notify deployment failure
      run: |
        echo "âŒ éƒ¨ç½²å¤±è´¥"
        echo "è¯·æ£€æŸ¥ä»¥ä¸‹å†…å®¹ï¼š"
        echo "1. Serv00 è´¦æˆ·å‡­æ®æ˜¯å¦æ­£ç¡®"
        echo "2. åŸŸåé…ç½®æ˜¯å¦æ­£ç¡®"
        echo "3. æ„å»ºè¿‡ç¨‹æ˜¯å¦æœ‰é”™è¯¯"
        echo "4. ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸"
