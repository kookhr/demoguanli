# 网络探测功能使用指南

## 概述

环境管理系统新增了基于 `<img>` 标签的网络探测功能，专门用于检测 IP+端口 格式地址的可达性。这种方法可以绕过 CORS 限制，提供更准确的网络连通性检测。

## 功能特点

### 🎯 智能探测策略
- **自动识别**：系统自动识别 IP+端口 格式的地址
- **多方法探测**：结合 fetch 和 img 标签探测，提高检测准确性
- **CORS 绕过**：使用 img 标签可以绕过浏览器的 CORS 限制

### 🔍 支持的地址格式
- `http://192.168.1.1:80` - 内网 HTTP 服务
- `https://10.0.0.50:443` - 内网 HTTPS 服务
- `http://172.16.0.1:8080` - 内网自定义端口
- `https://8.8.8.8:443` - 公网 IP 服务

### ⚡ 性能优化
- **缓存机制**：30秒缓存避免重复检测
- **并发控制**：可配置并发数量，默认6个
- **超时控制**：可配置超时时间，默认5秒

## 探测原理

### 1. 地址类型识别
```javascript
// 系统自动识别IP地址格式
const isIpAddress = (url) => {
  const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
  return ipv4Regex.test(hostname);
};
```

### 2. 探测流程
```
IP+端口地址 → fetch探测 → 成功 ✓
                ↓ 失败
            img标签探测 → 成功 ✓
                ↓ 失败
            标记为不可达 ✗

域名地址 → 标准fetch探测 → 结果
```

### 3. 探测路径
系统会尝试多个常见路径：
- `/favicon.ico` - 网站图标
- `/ping` - 健康检查端点
- `/health` - 健康检查端点
- `/status` - 状态检查端点
- `/robots.txt` - 机器人文件
- `/` - 根路径
- `/api/health` - API健康检查
- `/actuator/health` - Spring Boot健康检查

## 使用方法

### 1. 环境列表中的自动检测
- 系统会自动识别环境配置中的 IP+端口 地址
- 在状态检测时自动使用增强探测方法
- 检测结果会显示使用的探测方法

### 2. 网络测试工具
访问 `/network-test` 页面进行专门测试：

#### 单个地址测试
1. 在测试URL输入框中输入地址
2. 点击"测试"按钮
3. 查看详细的检测结果

#### 批量测试
1. 点击"批量测试预设地址"
2. 系统会测试多个预设的IP地址
3. 查看所有测试结果的对比

### 3. 配置选项
点击"显示设置"可以调整：
- **调试模式**：启用详细的控制台日志
- **启用图像探测**：开启/关闭 img 标签探测
- **超时时间**：调整 fetch 探测的超时时间
- **图像探测超时**：调整 img 探测的超时时间
- **并发数**：控制同时进行的检测数量
- **启用缓存**：开启/关闭结果缓存

## 检测结果说明

### 状态类型
- **可达** (available)：服务可以访问
- **不可达** (unreachable)：服务无法访问

### 检测方法
- **Fetch成功**：标准 fetch 探测成功
- **图像加载**：img 标签加载成功
- **图像探测**：img 标签探测到服务（即使返回错误）
- **增强检测**：使用了多种方法的综合检测
- **多方法探测**：尝试了所有方法

### 结果信息
- **响应时间**：检测耗时（毫秒）
- **检测方法**：使用的具体探测方法
- **详情**：探测过程的详细信息
- **错误信息**：失败时的错误描述

## 技术实现

### 核心代码结构
```
src/utils/simpleNetworkCheck.js
├── checkImageProbe()          # img标签探测
├── buildProbeUrls()           # 构造探测URL
├── isIpPortAddress()          # IP地址识别
├── checkEnhancedReachability() # 增强探测方法
└── checkEnvironmentStatus()    # 主检测函数
```

### 配置参数
```javascript
const SIMPLE_CHECK_CONFIG = {
  timeout: 5000,              // fetch超时时间
  imageProbeTimeout: 3000,    // img探测超时时间
  concurrency: 6,             // 并发数量
  cacheEnabled: true,         // 启用缓存
  enableImageProbe: true,     // 启用img探测
  debugMode: false            // 调试模式
};
```

## 最佳实践

### 1. 内网环境检测
- 使用较短的超时时间（3-5秒）
- 启用图像探测以绕过防火墙限制
- 适当增加并发数量

### 2. 外网环境检测
- 使用标准超时时间（5-10秒）
- 可以禁用图像探测，使用标准方法
- 控制并发数量避免被限流

### 3. 调试问题
- 启用调试模式查看详细日志
- 检查浏览器控制台的网络请求
- 对比不同探测方法的结果

## 注意事项

### 1. 浏览器限制
- 某些浏览器可能限制跨域图像请求
- HTTPS页面无法探测HTTP服务（混合内容限制）
- 部分防火墙可能阻止图像探测

### 2. 服务器配置
- 目标服务器需要响应探测路径
- 某些服务器可能阻止HEAD请求
- 防火墙设置可能影响探测结果

### 3. 性能考虑
- 大量并发探测可能影响网络性能
- 缓存机制可以减少重复请求
- 合理设置超时时间平衡速度和准确性

## 故障排除

### 常见问题
1. **所有IP地址都显示不可达**
   - 检查是否启用了图像探测
   - 确认网络连接正常
   - 查看浏览器控制台错误

2. **探测速度很慢**
   - 减少超时时间
   - 增加并发数量
   - 启用缓存机制

3. **结果不准确**
   - 启用调试模式查看详细信息
   - 对比不同探测方法的结果
   - 检查目标服务的实际状态

### 调试步骤
1. 启用调试模式
2. 打开浏览器开发者工具
3. 查看控制台日志
4. 检查网络请求详情
5. 对比手动访问结果
