<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>检测功能测试</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">检测功能测试</h1>
        
        <div class="bg-white rounded-lg shadow p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">简单网络检测测试</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">测试URL:</label>
                    <input 
                        type="url" 
                        id="testUrl" 
                        value="https://www.google.com" 
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <div class="flex gap-4">
                    <button 
                        onclick="testSingleCheck()" 
                        class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition-colors"
                    >
                        测试单个检测
                    </button>
                    <button 
                        onclick="testBatchCheck()" 
                        class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 transition-colors"
                    >
                        测试批量检测
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-semibold mb-4">检测结果</h2>
            <div id="results" class="space-y-2 text-sm font-mono bg-gray-50 p-4 rounded border min-h-32">
                等待测试...
            </div>
        </div>
    </div>

    <script type="module">
        // 简化的网络检测函数
        const checkNetworkReachability = async (url, timeout = 5000) => {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                await fetch(url, {
                    method: 'GET',
                    mode: 'no-cors',
                    signal: controller.signal,
                    cache: 'no-cache',
                    credentials: 'omit'
                });

                clearTimeout(timeoutId);
                return { reachable: true };
            } catch (error) {
                clearTimeout(timeoutId);
                return { reachable: false, error: error.message };
            }
        };

        const checkEnvironmentStatus = async (environment) => {
            const startTime = Date.now();

            try {
                const reachabilityResult = await checkNetworkReachability(environment.url);

                const result = {
                    id: environment.id,
                    status: reachabilityResult.reachable ? 'available' : 'unreachable',
                    responseTime: Date.now() - startTime,
                    lastChecked: new Date().toISOString(),
                    error: reachabilityResult.error || null,
                    method: 'no-cors',
                    statusCode: null
                };

                return result;
            } catch (error) {
                const result = {
                    id: environment.id,
                    status: 'unreachable',
                    responseTime: Date.now() - startTime,
                    lastChecked: new Date().toISOString(),
                    error: `检测异常: ${error.message}`,
                    method: 'exception',
                    statusCode: null
                };

                return result;
            }
        };

        const logResult = (message) => {
            const results = document.getElementById('results');
            const timestamp = new Date().toLocaleTimeString();
            results.innerHTML += `[${timestamp}] ${message}\n`;
            results.scrollTop = results.scrollHeight;
        };

        window.testSingleCheck = async () => {
            const url = document.getElementById('testUrl').value;
            if (!url) {
                logResult('❌ 请输入有效的URL');
                return;
            }

            logResult(`🔍 开始检测: ${url}`);
            
            const environment = {
                id: 'test-' + Date.now(),
                name: '测试环境',
                url: url
            };

            try {
                const result = await checkEnvironmentStatus(environment);
                logResult(`✅ 检测完成: ${JSON.stringify(result, null, 2)}`);
            } catch (error) {
                logResult(`❌ 检测失败: ${error.message}`);
            }
        };

        window.testBatchCheck = async () => {
            const testUrls = [
                'https://www.google.com',
                'https://github.com',
                'https://www.baidu.com',
                'https://httpbin.org/status/200'
            ];

            logResult(`🔍 开始批量检测 ${testUrls.length} 个URL`);

            const environments = testUrls.map((url, index) => ({
                id: `test-${index}`,
                name: `测试环境${index + 1}`,
                url: url
            }));

            for (const env of environments) {
                try {
                    logResult(`🔍 检测: ${env.url}`);
                    const result = await checkEnvironmentStatus(env);
                    logResult(`  ➜ 结果: ${result.status} (${result.responseTime}ms)`);
                } catch (error) {
                    logResult(`  ➜ 错误: ${error.message}`);
                }
            }

            logResult(`✅ 批量检测完成`);
        };

        // 清空结果
        window.clearResults = () => {
            document.getElementById('results').innerHTML = '等待测试...';
        };

        // 初始化
        logResult('🚀 检测功能测试页面已加载');
        logResult('💡 点击按钮开始测试网络检测功能');
    </script>
</body>
</html>
