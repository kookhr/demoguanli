#!/bin/bash

# Serv00 API 502 ÈîôËØØ‰øÆÂ§çËÑöÊú¨
# ‰øÆÂ§çÂêéÁ´Ø PHP API ÊúçÂä°ÈóÆÈ¢ò

set -e

# È¢úËâ≤ÂÆö‰πâ
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
BOLD='\033[1m'
NC='\033[0m'

DOMAIN="do.kandy.dpdns.org"
SITE_DIR="$HOME/domains/$DOMAIN/public_html"
API_DIR="$SITE_DIR/api"

echo -e "${BOLD}${BLUE}üîß Serv00 API 502 ÈîôËØØ‰øÆÂ§ç${NC}"
echo -e "${CYAN}ÁõÆÊ†áÂüüÂêç: $DOMAIN${NC}"
echo -e "${CYAN}API ÁõÆÂΩï: $API_DIR${NC}"
echo ""

# 1. Ê£ÄÊü• API ÁõÆÂΩïÁªìÊûÑ
check_api_structure() {
    echo -e "${BOLD}${BLUE}üìÅ Ê≠•È™§1: Ê£ÄÊü• API ÁõÆÂΩïÁªìÊûÑ${NC}"
    
    cd "$SITE_DIR"
    
    if [ ! -d "api" ]; then
        echo -e "${RED}‚ùå API ÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏≠...${NC}"
        mkdir -p api
    fi
    
    cd api
    
    # Ê£ÄÊü•ÂÖ≥ÈîÆÊñá‰ª∂
    local api_files=(
        ".env"
        "index.php"
        ".htaccess"
    )
    
    for file in "${api_files[@]}"; do
        if [ -f "$file" ]; then
            echo -e "${GREEN}‚úÖ $file Â≠òÂú®${NC}"
            ls -la "$file"
        else
            echo -e "${RED}‚ùå $file Áº∫Â§±${NC}"
        fi
    done
    
    echo ""
}

# 2. ÂàõÂª∫Âü∫Á°Ä API Êñá‰ª∂
create_basic_api() {
    echo -e "${BOLD}${BLUE}üìã Ê≠•È™§2: ÂàõÂª∫Âü∫Á°Ä API Êñá‰ª∂${NC}"
    
    cd "$API_DIR"
    
    # ÂàõÂª∫ API .htaccess
    cat > ".htaccess" << 'EOF'
# API ÁõÆÂΩïÈÖçÁΩÆ
RewriteEngine On

# ËÆæÁΩÆ PHP ÈîôËØØÊòæÁ§∫ÔºàË∞ÉËØïÁî®Ôºâ
php_flag display_errors On
php_flag display_startup_errors On
php_value error_reporting "E_ALL"

# ËÆæÁΩÆ CORS Â§¥
Header always set Access-Control-Allow-Origin "*"
Header always set Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
Header always set Access-Control-Allow-Headers "Content-Type, Authorization, X-Requested-With"

# Â§ÑÁêÜ OPTIONS ËØ∑Ê±Ç
RewriteCond %{REQUEST_METHOD} OPTIONS
RewriteRule ^(.*)$ index.php [QSA,L]

# Ë∑ØÁî±ÊâÄÊúâËØ∑Ê±ÇÂà∞ index.php
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule ^(.*)$ index.php [QSA,L]
EOF
    
    echo -e "${GREEN}‚úÖ ÂàõÂª∫‰∫Ü API .htaccess${NC}"
    
    # ÂàõÂª∫Âü∫Á°Ä index.php
    cat > "index.php" << 'EOF'
<?php
// Serv00 ÁéØÂ¢ÉÁÆ°ÁêÜÁ≥ªÁªü API
// Âü∫Á°ÄÁâàÊú¨ÔºåÁî®‰∫é‰øÆÂ§ç 502 ÈîôËØØ

// ËÆæÁΩÆÈîôËØØÊä•Âëä
error_reporting(E_ALL);
ini_set('display_errors', 1);

// ËÆæÁΩÆ CORS Â§¥
header('Access-Control-Allow-Origin: *');
header('Access-Control-Allow-Methods: GET, POST, PUT, DELETE, OPTIONS');
header('Access-Control-Allow-Headers: Content-Type, Authorization, X-Requested-With');
header('Content-Type: application/json; charset=utf-8');

// Â§ÑÁêÜ OPTIONS ËØ∑Ê±Ç
if ($_SERVER['REQUEST_METHOD'] === 'OPTIONS') {
    http_response_code(200);
    exit();
}

// Ëé∑ÂèñËØ∑Ê±ÇË∑ØÂæÑ
$request_uri = $_SERVER['REQUEST_URI'];
$path = parse_url($request_uri, PHP_URL_PATH);
$path = str_replace('/api', '', $path);
$path = trim($path, '/');

// Âü∫Á°ÄË∑ØÁî±
switch ($path) {
    case 'health':
        handleHealth();
        break;
    
    case 'environments':
        handleEnvironments();
        break;
    
    case 'test':
        handleTest();
        break;
    
    default:
        handleNotFound();
        break;
}

// ÂÅ•Â∫∑Ê£ÄÊü•
function handleHealth() {
    $response = [
        'status' => 'success',
        'message' => 'API ËøêË°åÊ≠£Â∏∏',
        'data' => [
            'timestamp' => date('Y-m-d H:i:s'),
            'server' => 'Serv00',
            'php_version' => PHP_VERSION,
            'database' => checkDatabase()
        ]
    ];
    
    echo json_encode($response, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
}

// ÁéØÂ¢ÉÂàóË°®
function handleEnvironments() {
    // Ê®°ÊãüÁéØÂ¢ÉÊï∞ÊçÆ
    $environments = [
        [
            'id' => 1,
            'name' => 'ÊµãËØïÁéØÂ¢É',
            'url' => 'https://test.example.com',
            'status' => 'online',
            'type' => 'external'
        ],
        [
            'id' => 2,
            'name' => 'Áîü‰∫ßÁéØÂ¢É',
            'url' => 'https://prod.example.com',
            'status' => 'online',
            'type' => 'external'
        ]
    ];
    
    $response = [
        'status' => 'success',
        'message' => 'ÁéØÂ¢ÉÂàóË°®Ëé∑ÂèñÊàêÂäü',
        'data' => $environments
    ];
    
    echo json_encode($response, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
}

// ÊµãËØïÊé•Âè£
function handleTest() {
    $response = [
        'status' => 'success',
        'message' => 'API ÊµãËØïÊàêÂäü',
        'data' => [
            'method' => $_SERVER['REQUEST_METHOD'],
            'timestamp' => time(),
            'user_agent' => $_SERVER['HTTP_USER_AGENT'] ?? 'Unknown',
            'ip' => $_SERVER['REMOTE_ADDR'] ?? 'Unknown'
        ]
    ];
    
    echo json_encode($response, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
}

// 404 Â§ÑÁêÜ
function handleNotFound() {
    http_response_code(404);
    
    $response = [
        'status' => 'error',
        'message' => 'Êé•Âè£‰∏çÂ≠òÂú®',
        'data' => [
            'path' => $_SERVER['REQUEST_URI'],
            'available_endpoints' => [
                '/api/health',
                '/api/environments',
                '/api/test'
            ]
        ]
    ];
    
    echo json_encode($response, JSON_PRETTY_PRINT | JSON_UNESCAPED_UNICODE);
}

// Ê£ÄÊü•Êï∞ÊçÆÂ∫ìËøûÊé•
function checkDatabase() {
    $env_file = __DIR__ . '/.env';
    
    if (!file_exists($env_file)) {
        return 'ÈÖçÁΩÆÊñá‰ª∂‰∏çÂ≠òÂú®';
    }
    
    // ËØªÂèñ .env Êñá‰ª∂
    $env_vars = [];
    $lines = file($env_file, FILE_IGNORE_NEW_LINES | FILE_SKIP_EMPTY_LINES);
    
    foreach ($lines as $line) {
        if (strpos($line, '=') !== false && !str_starts_with(trim($line), '#')) {
            list($key, $value) = explode('=', $line, 2);
            $env_vars[trim($key)] = trim($value, '"\'');
        }
    }
    
    // Ê£ÄÊü•Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ
    $required_keys = ['DB_HOST', 'DB_NAME', 'DB_USER', 'DB_PASSWORD'];
    foreach ($required_keys as $key) {
        if (!isset($env_vars[$key]) || empty($env_vars[$key])) {
            return "Áº∫Â∞ëÈÖçÁΩÆ: $key";
        }
    }
    
    // Â∞ùËØïËøûÊé•Êï∞ÊçÆÂ∫ì
    try {
        $dsn = "mysql:host={$env_vars['DB_HOST']};dbname={$env_vars['DB_NAME']};charset=utf8mb4";
        $pdo = new PDO($dsn, $env_vars['DB_USER'], $env_vars['DB_PASSWORD'], [
            PDO::ATTR_ERRMODE => PDO::ERRMODE_EXCEPTION,
            PDO::ATTR_DEFAULT_FETCH_MODE => PDO::FETCH_ASSOC,
            PDO::ATTR_TIMEOUT => 5
        ]);
        
        return 'Êï∞ÊçÆÂ∫ìËøûÊé•Ê≠£Â∏∏';
    } catch (PDOException $e) {
        return 'Êï∞ÊçÆÂ∫ìËøûÊé•Â§±Ë¥•: ' . $e->getMessage();
    }
}
?>
EOF
    
    echo -e "${GREEN}‚úÖ ÂàõÂª∫‰∫ÜÂü∫Á°Ä API index.php${NC}"
    
    # ÂàõÂª∫ÊµãËØïÁî®ÁöÑ .env Êñá‰ª∂ÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
    if [ ! -f ".env" ]; then
        cat > ".env" << 'EOF'
# Serv00 ÁéØÂ¢ÉÁÆ°ÁêÜÁ≥ªÁªüÈÖçÁΩÆÊñá‰ª∂
# ËØ∑Ê†πÊçÆÂÆûÈôÖÊÉÖÂÜµ‰øÆÊîπ

# Êï∞ÊçÆÂ∫ìÈÖçÁΩÆ
DB_HOST=mysql14.serv00.com
DB_NAME=m9785_environment_manager
DB_USER=m9785_s14kook
DB_PASSWORD=your_password_here
DB_PORT=3306

# Â∫îÁî®ÈÖçÁΩÆ
APP_ENV=production
APP_DEBUG=false
APP_URL=https://do.kandy.dpdns.org
CUSTOM_PORT=3000

# API ÈÖçÁΩÆ
API_BASE_URL=/api
JWT_SECRET=fallback_secret_12345
JWT_EXPIRATION=86400
EOF
        
        echo -e "${YELLOW}‚ö†Ô∏è ÂàõÂª∫‰∫ÜÁ§∫‰æã .env Êñá‰ª∂ÔºåËØ∑‰øÆÊîπÊï∞ÊçÆÂ∫ìÂØÜÁ†Å${NC}"
    fi
    
    echo ""
}

# 3. ‰øÆÂ§çÊñá‰ª∂ÊùÉÈôê
fix_api_permissions() {
    echo -e "${BOLD}${BLUE}üîê Ê≠•È™§3: ‰øÆÂ§ç API Êñá‰ª∂ÊùÉÈôê${NC}"
    
    cd "$API_DIR"
    
    # ËÆæÁΩÆÁõÆÂΩïÊùÉÈôê
    chmod 755 .
    
    # ËÆæÁΩÆÊñá‰ª∂ÊùÉÈôê
    chmod 644 index.php
    chmod 644 .htaccess
    chmod 600 .env
    
    echo -e "${GREEN}‚úÖ API Êñá‰ª∂ÊùÉÈôê‰øÆÂ§çÂÆåÊàê${NC}"
    echo ""
}

# 4. ÊµãËØï API
test_api() {
    echo -e "${BOLD}${BLUE}üß™ Ê≠•È™§4: ÊµãËØï API${NC}"
    
    # ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•
    echo -e "${BLUE}üìã ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•Êé•Âè£:${NC}"
    if curl -s "https://$DOMAIN/api/health" | head -10; then
        echo -e "${GREEN}‚úÖ ÂÅ•Â∫∑Ê£ÄÊü•Êé•Âè£Ê≠£Â∏∏${NC}"
    else
        echo -e "${RED}‚ùå ÂÅ•Â∫∑Ê£ÄÊü•Êé•Âè£Â§±Ë¥•${NC}"
    fi
    
    echo ""
    
    # ÊµãËØïÁéØÂ¢ÉÂàóË°®
    echo -e "${BLUE}üìã ÊµãËØïÁéØÂ¢ÉÂàóË°®Êé•Âè£:${NC}"
    if curl -s "https://$DOMAIN/api/environments" | head -10; then
        echo -e "${GREEN}‚úÖ ÁéØÂ¢ÉÂàóË°®Êé•Âè£Ê≠£Â∏∏${NC}"
    else
        echo -e "${RED}‚ùå ÁéØÂ¢ÉÂàóË°®Êé•Âè£Â§±Ë¥•${NC}"
    fi
    
    echo ""
    
    # ÊµãËØï HTTP ÂìçÂ∫îÁ†Å
    echo -e "${BLUE}üìã Ê£ÄÊü• HTTP ÂìçÂ∫îÁ†Å:${NC}"
    local status_code=$(curl -s -o /dev/null -w "%{http_code}" "https://$DOMAIN/api/health")
    echo -e "ÂìçÂ∫îÁ†Å: $status_code"
    
    if [ "$status_code" = "200" ]; then
        echo -e "${GREEN}‚úÖ HTTP ÂìçÂ∫îÁ†ÅÊ≠£Â∏∏${NC}"
    else
        echo -e "${RED}‚ùå HTTP ÂìçÂ∫îÁ†ÅÂºÇÂ∏∏: $status_code${NC}"
    fi
    
    echo ""
}

# 5. ÂàõÂª∫ API ÊµãËØïÈ°µÈù¢
create_api_test_page() {
    echo -e "${BOLD}${BLUE}üìã Ê≠•È™§5: ÂàõÂª∫ API ÊµãËØïÈ°µÈù¢${NC}"
    
    cd "$SITE_DIR"
    
    cat > "api-test.html" << 'EOF'
<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API ÊµãËØïÈ°µÈù¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-item {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { border-color: #4CAF50; background: #f1f8e9; }
        .error { border-color: #f44336; background: #ffebee; }
        .loading { border-color: #2196F3; background: #e3f2fd; }
        button {
            padding: 8px 16px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #1976D2; }
        pre {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ API ÊµãËØïÈ°µÈù¢</h1>
        
        <div class="test-item" id="health-test">
            <h3>ÂÅ•Â∫∑Ê£ÄÊü• (/api/health)</h3>
            <button onclick="testHealth()">ÊµãËØïÂÅ•Â∫∑Ê£ÄÊü•</button>
            <div id="health-result"></div>
        </div>
        
        <div class="test-item" id="env-test">
            <h3>ÁéØÂ¢ÉÂàóË°® (/api/environments)</h3>
            <button onclick="testEnvironments()">ÊµãËØïÁéØÂ¢ÉÂàóË°®</button>
            <div id="env-result"></div>
        </div>
        
        <div class="test-item" id="test-test">
            <h3>ÊµãËØïÊé•Âè£ (/api/test)</h3>
            <button onclick="testTest()">ÊµãËØïÊé•Âè£</button>
            <div id="test-result"></div>
        </div>
        
        <div class="test-item">
            <h3>ÊâπÈáèÊµãËØï</h3>
            <button onclick="runAllTests()">ËøêË°åÊâÄÊúâÊµãËØï</button>
        </div>
    </div>
    
    <script>
        async function testAPI(endpoint, resultId) {
            const resultEl = document.getElementById(resultId);
            resultEl.innerHTML = '<p>Ê≠£Âú®ÊµãËØï...</p>';
            
            try {
                const response = await fetch(`/api/${endpoint}`);
                const data = await response.json();
                
                resultEl.innerHTML = `
                    <p><strong>Áä∂ÊÄÅÁ†Å:</strong> ${response.status}</p>
                    <p><strong>ÂìçÂ∫î:</strong></p>
                    <pre>${JSON.stringify(data, null, 2)}</pre>
                `;
                
                if (response.ok) {
                    document.getElementById(resultId.replace('-result', '-test')).className = 'test-item success';
                } else {
                    document.getElementById(resultId.replace('-result', '-test')).className = 'test-item error';
                }
            } catch (error) {
                resultEl.innerHTML = `<p><strong>ÈîôËØØ:</strong> ${error.message}</p>`;
                document.getElementById(resultId.replace('-result', '-test')).className = 'test-item error';
            }
        }
        
        function testHealth() {
            testAPI('health', 'health-result');
        }
        
        function testEnvironments() {
            testAPI('environments', 'env-result');
        }
        
        function testTest() {
            testAPI('test', 'test-result');
        }
        
        async function runAllTests() {
            testHealth();
            await new Promise(resolve => setTimeout(resolve, 1000));
            testEnvironments();
            await new Promise(resolve => setTimeout(resolve, 1000));
            testTest();
        }
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëá™Âä®ËøêË°åÂÅ•Â∫∑Ê£ÄÊü•
        window.onload = function() {
            testHealth();
        };
    </script>
</body>
</html>
EOF
    
    echo -e "${GREEN}‚úÖ ÂàõÂª∫‰∫Ü API ÊµãËØïÈ°µÈù¢: api-test.html${NC}"
    echo -e "${BLUE}üìã ËÆøÈóÆ: https://$DOMAIN/api-test.html${NC}"
    echo ""
}

# ‰∏ªÂáΩÊï∞
main() {
    echo -e "${BOLD}ÂºÄÂßã‰øÆÂ§ç API 502 ÈîôËØØ...${NC}"
    echo ""
    
    check_api_structure
    create_basic_api
    fix_api_permissions
    test_api
    create_api_test_page
    
    echo -e "${BOLD}${GREEN}üéâ API ‰øÆÂ§çÂÆåÊàêÔºÅ${NC}"
    echo ""
    echo -e "${BOLD}${CYAN}ÊµãËØïÊ≠•È™§:${NC}"
    echo -e "1. ËÆøÈóÆ API ÊµãËØïÈ°µÈù¢: https://$DOMAIN/api-test.html"
    echo -e "2. Áõ¥Êé•ËÆøÈóÆÂÅ•Â∫∑Ê£ÄÊü•: https://$DOMAIN/api/health"
    echo -e "3. Ê£ÄÊü•ÁéØÂ¢ÉÂàóË°®: https://$DOMAIN/api/environments"
    echo ""
    echo -e "${BOLD}${YELLOW}ÈáçË¶ÅÊèêÈÜí:${NC}"
    echo -e "1. ËØ∑ÁºñËæë $API_DIR/.env Êñá‰ª∂ÔºåÂ°´ÂÖ•Ê≠£Á°ÆÁöÑÊï∞ÊçÆÂ∫ìÂØÜÁ†Å"
    echo -e "2. Â¶ÇÊûú‰ªçÊúâÈóÆÈ¢òÔºåËØ∑Ê£ÄÊü• Serv00 ÁöÑ PHP ÈîôËØØÊó•Âøó"
    echo -e "3. Á°Æ‰øùÊï∞ÊçÆÂ∫ìÊúçÂä°Ê≠£Â∏∏ËøêË°å"
}

# ËÑöÊú¨ÂÖ•Âè£
if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
