# 环境状态检测功能说明

## 🚀 功能概述

环境管理系统现在具备了真实的状态检测功能，不再依赖配置文件中的静态状态，而是通过实际网络请求来检测环境的可用性。

## ✨ 主要特性

### 1. 多层次检测策略
- **主要方法**: 使用 `fetch` API 发送 HEAD 请求
- **备用方法**: 当遇到 CORS 问题时，使用 `no-cors` 模式
- **兜底方法**: 使用 Image 对象检测 favicon 可达性

### 2. 智能状态识别
- **在线 (online)**: 服务正常响应
- **离线 (offline)**: 服务不可访问
- **超时 (timeout)**: 响应时间超过设定阈值
- **错误 (error)**: 检测过程中出现错误
- **可达 (reachable)**: 服务器可达但状态未知
- **未检测 (unknown)**: 尚未进行状态检测

### 3. 性能优化
- **缓存机制**: 30秒内的检测结果会被缓存
- **并发控制**: 批量检测时限制最大并发数为3
- **超时控制**: 单次检测超时时间为8-10秒
- **进度显示**: 批量检测时显示实时进度

### 4. 用户体验
- **自动检测**: 页面加载时自动进行后台检测
- **手动刷新**: 支持单个环境或批量刷新
- **实时更新**: 状态变化立即反映在界面上
- **详细信息**: 显示检测时间和错误信息

## 🛠 技术实现

### 检测流程
```javascript
1. 检查缓存 → 2. 发送 HEAD 请求 → 3. 处理响应
                     ↓ (CORS错误)
4. 使用 no-cors 模式 → 5. Image ping 检测 → 6. 返回结果
```

### 状态映射
```javascript
const statusMapping = {
  'online': '✅ 服务正常运行',
  'offline': '❌ 服务不可访问', 
  'timeout': '⏰ 响应时间过长',
  'error': '🚫 检测过程中出现错误',
  'reachable': '📡 服务器可达，但状态未知',
  'unknown': '❓ 尚未检测状态'
};
```

## 📊 测试环境

为了演示不同的状态检测效果，系统预置了以下测试环境：

1. **Google 搜索** - 测试正常在线状态
2. **GitHub** - 测试正常在线状态  
3. **本地开发服务器** - 测试内网环境
4. **不存在的服务** - 测试离线状态
5. **超时测试服务** - 测试超时状态
6. **错误测试服务** - 测试错误状态

## 🎯 使用方法

### 自动检测
- 页面加载时自动进行后台检测
- 检测结果会缓存30秒，避免频繁请求

### 手动检测
- **单个环境**: 点击环境卡片上的"检测"按钮
- **批量检测**: 点击页面顶部的"检测所有"按钮

### 查看详情
- 状态指示器显示当前状态和描述
- 鼠标悬停查看详细信息
- 检测时间和错误信息实时显示

## ⚙️ 配置选项

### 检测参数
```javascript
const options = {
  useCache: true,        // 是否使用缓存
  timeout: 8000,         // 超时时间(毫秒)
  maxConcurrent: 3       // 最大并发数
};
```

### 缓存设置
```javascript
const CACHE_DURATION = 30000; // 缓存时间30秒
```

## 🔧 自定义配置

### 添加新环境
1. 进入配置管理页面
2. 点击"添加环境"
3. 填写环境信息，确保URL正确
4. 保存后系统会自动检测状态

### 调整检测参数
修改 `src/utils/networkCheck.js` 中的相关参数：
- 调整超时时间
- 修改缓存时长
- 更改并发数限制

## 🚨 注意事项

### CORS 限制
- 某些网站可能阻止跨域请求
- 系统会自动使用备用检测方法
- 使用多层次检测策略绕过CORS限制

### 网络环境
- 所有环境都会进行统一的状态检测
- 网络类型标签仅用于分类和视觉识别
- 不再区分内网外网的检测限制

### 性能考虑
- 避免频繁手动刷新
- 大量环境时检测可能需要较长时间
- 建议合理设置超时时间

## 📈 未来优化

- [ ] 支持自定义检测间隔
- [ ] 添加健康检查端点
- [ ] 支持认证环境检测
- [ ] 添加历史状态记录
- [ ] 支持告警通知功能
