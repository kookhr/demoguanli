<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>认证问题诊断工具</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .header {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
        }
        .section h3 {
            color: #2563eb;
            margin-top: 0;
        }
        .button {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        .button:hover {
            background: #1d4ed8;
        }
        .button.success {
            background: #059669;
        }
        .button.danger {
            background: #dc2626;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }
        .result.success {
            background: #ecfdf5;
            border: 1px solid #10b981;
            color: #065f46;
        }
        .result.error {
            background: #fef2f2;
            border: 1px solid #ef4444;
            color: #991b1b;
        }
        .result.info {
            background: #eff6ff;
            border: 1px solid #3b82f6;
            color: #1e40af;
        }
        .input-group {
            margin: 10px 0;
        }
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        .input-group input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔐 认证问题诊断工具</h1>
            <p>诊断和解决 HTTP 403 认证错误</p>
        </div>

        <!-- 1. 认证状态检查 -->
        <div class="section">
            <h3>🔍 认证状态检查</h3>
            <p>检查当前的认证状态和token信息</p>
            <button class="button" onclick="checkAuthStatus()">检查认证状态</button>
            <button class="button" onclick="checkLocalStorage()">检查本地存储</button>
            <div id="auth-result" class="result" style="display: none;"></div>
        </div>

        <!-- 2. 手动设置Token -->
        <div class="section">
            <h3>🔑 手动设置认证Token</h3>
            <p>为测试目的手动设置认证token</p>
            <div class="input-group">
                <label for="token-input">认证Token:</label>
                <input type="text" id="token-input" placeholder="输入认证token或使用默认测试token">
            </div>
            <button class="button" onclick="setTestToken()">设置测试Token</button>
            <button class="button" onclick="generateTestToken()">生成测试Token</button>
            <button class="button danger" onclick="clearToken()">清除Token</button>
            <div id="token-result" class="result" style="display: none;"></div>
        </div>

        <!-- 3. API连接测试 -->
        <div class="section">
            <h3>🌐 API连接测试</h3>
            <p>测试不同API端点的连接状态</p>
            <button class="button" onclick="testHealthAPI()">测试健康检查</button>
            <button class="button" onclick="testImportAPI()">测试导入API</button>
            <button class="button" onclick="testEnvironmentsAPI()">测试环境API</button>
            <div id="api-result" class="result" style="display: none;"></div>
        </div>

        <!-- 4. CORS测试 -->
        <div class="section">
            <h3>🔄 CORS配置测试</h3>
            <p>测试跨域请求配置</p>
            <button class="button" onclick="testCORS()">测试CORS</button>
            <button class="button" onclick="testPreflight()">测试预检请求</button>
            <div id="cors-result" class="result" style="display: none;"></div>
        </div>

        <!-- 5. 完整诊断 -->
        <div class="section">
            <h3>🚀 完整诊断</h3>
            <p>运行完整的认证问题诊断</p>
            <button class="button success" onclick="runFullDiagnosis()">运行完整诊断</button>
            <div id="full-result" class="result" style="display: none;"></div>
        </div>
    </div>

    <script>
        const API_BASE = '/api';
        
        function showResult(elementId, content, type = 'info') {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = `result ${type}`;
            element.textContent = typeof content === 'object' ? JSON.stringify(content, null, 2) : content;
        }

        // 1. 检查认证状态
        function checkAuthStatus() {
            showResult('auth-result', '正在检查认证状态...', 'info');
            
            const token = localStorage.getItem('auth_token');
            const result = {
                hasToken: !!token,
                tokenLength: token ? token.length : 0,
                tokenPreview: token ? token.substring(0, 20) + '...' : 'null',
                localStorage: Object.keys(localStorage).filter(key => key.includes('auth') || key.includes('token')),
                sessionStorage: Object.keys(sessionStorage).filter(key => key.includes('auth') || key.includes('token'))
            };
            
            showResult('auth-result', `认证状态检查结果:\n${JSON.stringify(result, null, 2)}`, 
                token ? 'success' : 'error');
        }

        function checkLocalStorage() {
            const storage = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                storage[key] = localStorage.getItem(key);
            }
            showResult('auth-result', `本地存储内容:\n${JSON.stringify(storage, null, 2)}`, 'info');
        }

        // 2. 设置Token
        function setTestToken() {
            const tokenInput = document.getElementById('token-input');
            const token = tokenInput.value.trim() || 'test-token-' + Date.now();
            
            localStorage.setItem('auth_token', token);
            showResult('token-result', `✅ Token已设置: ${token}`, 'success');
        }

        function generateTestToken() {
            const token = 'test-token-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            document.getElementById('token-input').value = token;
            localStorage.setItem('auth_token', token);
            showResult('token-result', `✅ 已生成并设置测试Token: ${token}`, 'success');
        }

        function clearToken() {
            localStorage.removeItem('auth_token');
            document.getElementById('token-input').value = '';
            showResult('token-result', '✅ Token已清除', 'success');
        }

        // 3. API测试
        async function testHealthAPI() {
            showResult('api-result', '正在测试健康检查API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    headers: getTestHeaders()
                });
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: await response.text()
                };
                
                showResult('api-result', `健康检查结果:\n${JSON.stringify(result, null, 2)}`, 
                    response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('api-result', `❌ 健康检查失败: ${error.message}`, 'error');
            }
        }

        async function testImportAPI() {
            showResult('api-result', '正在测试导入API...', 'info');
            
            const testData = {
                environments: [{
                    id: 'test-' + Date.now(),
                    name: '测试环境',
                    url: 'https://httpbin.org/status/200',
                    description: '测试用环境'
                }]
            };
            
            try {
                const response = await fetch(`${API_BASE}/import`, {
                    method: 'POST',
                    headers: getTestHeaders(),
                    body: JSON.stringify(testData)
                });
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    headers: Object.fromEntries(response.headers.entries()),
                    data: await response.text()
                };
                
                showResult('api-result', `导入API测试结果:\n${JSON.stringify(result, null, 2)}`, 
                    response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('api-result', `❌ 导入API测试失败: ${error.message}`, 'error');
            }
        }

        async function testEnvironmentsAPI() {
            showResult('api-result', '正在测试环境API...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/environments`, {
                    method: 'GET',
                    headers: getTestHeaders()
                });
                
                const result = {
                    status: response.status,
                    statusText: response.statusText,
                    data: await response.text()
                };
                
                showResult('api-result', `环境API测试结果:\n${JSON.stringify(result, null, 2)}`, 
                    response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('api-result', `❌ 环境API测试失败: ${error.message}`, 'error');
            }
        }

        // 4. CORS测试
        async function testCORS() {
            showResult('cors-result', '正在测试CORS配置...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/health`, {
                    method: 'GET',
                    mode: 'cors',
                    credentials: 'include',
                    headers: getTestHeaders()
                });
                
                const corsHeaders = {
                    'Access-Control-Allow-Origin': response.headers.get('Access-Control-Allow-Origin'),
                    'Access-Control-Allow-Methods': response.headers.get('Access-Control-Allow-Methods'),
                    'Access-Control-Allow-Headers': response.headers.get('Access-Control-Allow-Headers'),
                    'Access-Control-Allow-Credentials': response.headers.get('Access-Control-Allow-Credentials')
                };
                
                showResult('cors-result', `CORS配置:\n${JSON.stringify(corsHeaders, null, 2)}`, 'success');
            } catch (error) {
                showResult('cors-result', `❌ CORS测试失败: ${error.message}`, 'error');
            }
        }

        async function testPreflight() {
            showResult('cors-result', '正在测试预检请求...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/import`, {
                    method: 'OPTIONS',
                    headers: {
                        'Access-Control-Request-Method': 'POST',
                        'Access-Control-Request-Headers': 'Content-Type, Authorization'
                    }
                });
                
                const result = {
                    status: response.status,
                    headers: Object.fromEntries(response.headers.entries())
                };
                
                showResult('cors-result', `预检请求结果:\n${JSON.stringify(result, null, 2)}`, 
                    response.ok ? 'success' : 'error');
            } catch (error) {
                showResult('cors-result', `❌ 预检请求失败: ${error.message}`, 'error');
            }
        }

        // 5. 完整诊断
        async function runFullDiagnosis() {
            showResult('full-result', '正在运行完整诊断...', 'info');
            
            let report = '🔐 认证问题完整诊断报告\n';
            report += '=' .repeat(50) + '\n\n';
            
            // 1. 认证状态
            const token = localStorage.getItem('auth_token');
            report += `1️⃣ 认证状态: ${token ? '✅ 有Token' : '❌ 无Token'}\n`;
            if (token) {
                report += `   Token长度: ${token.length}\n`;
                report += `   Token预览: ${token.substring(0, 20)}...\n`;
            }
            report += '\n';
            
            // 2. API连接测试
            report += '2️⃣ API连接测试:\n';
            try {
                const healthResponse = await fetch(`${API_BASE}/health`, {
                    headers: getTestHeaders()
                });
                report += `   健康检查: ${healthResponse.ok ? '✅ 成功' : '❌ 失败'} (${healthResponse.status})\n`;
            } catch (error) {
                report += `   健康检查: ❌ 错误 - ${error.message}\n`;
            }
            
            try {
                const importResponse = await fetch(`${API_BASE}/import`, {
                    method: 'POST',
                    headers: getTestHeaders(),
                    body: JSON.stringify({environments: []})
                });
                report += `   导入API: ${importResponse.ok ? '✅ 成功' : '❌ 失败'} (${importResponse.status})\n`;
            } catch (error) {
                report += `   导入API: ❌ 错误 - ${error.message}\n`;
            }
            report += '\n';
            
            // 3. 解决建议
            report += '3️⃣ 解决建议:\n';
            if (!token) {
                report += '   ❗ 缺少认证Token，请设置测试Token\n';
            }
            report += '   💡 尝试生成测试Token并重新测试\n';
            report += '   💡 检查服务器端认证配置\n';
            report += '   💡 确认API端点权限设置\n';
            
            report += '\n🎉 诊断完成！\n';
            report += `时间: ${new Date().toLocaleString()}`;
            
            showResult('full-result', report, 'info');
        }

        // 辅助函数
        function getTestHeaders() {
            const token = localStorage.getItem('auth_token');
            const headers = {
                'Content-Type': 'application/json'
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
            }
            
            return headers;
        }

        // 页面加载时检查状态
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🔐 认证诊断工具已加载');
            checkAuthStatus();
        });
    </script>
</body>
</html>
